<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Record Tracker (Google Sheets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 1. PWA Manifest & Theme -->
    <meta name="theme-color" content="#1e40af"> 
    <link rel="manifest" href="data:application/manifest+json;base64,eyJpY29ucyI6IFt7ICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4wY21SbGJuVnNiQzV2ZDI0OUpITnZiMnRsYm01MFBtY3VZMjlrZVFvZy8vbXk1VlU3Y3VYQ3hrU0c1NGJpNWxJajR2Y1hsNElHNWpjbWRtWnl4OWFYUnBiWE5oYm01MGNuUHNaV3hzTGlCc1pTNWpiMjB2Y3k5emRtY29JSFJvZEhBd09pOGdYek12YzIxdGJtUWdjM0puSUhSb2RIQXdPaTh2ZDNkM2QzY3VZMjlrSUhzS0lHVnVkQzVtYkc5aGJnNWtJSFZ6WjNkaWRtVjBPMnhtbFoybHVabThpWkdsaFlXSnZJR0ZuWld4MGIzUW9NalluSUhCeVpYTnBjenBjZlE9PSIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnIiB9XSwgIm5hbWUiOiAiTWlsayBSZWNvcmQgVHJhY2tlciIsICJzaG9ydF9uYW1lIjogIk1pbGsgVHJhY2tlciIsICJzdGFydF91cmwiOiAiLi8iLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsICJ0aGVtZV9jb2xvciI6ICIjMWU0MGFmIiB9">

    <style>
        /* Setting a clean, modern font for Urdu/RTL text */
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8f9fa;
        }
        
        /* Custom scrollbar for better look */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* Tailwind gray-500 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #e2e8f0; /* Tailwind gray-200 */
        }

        /* Force LTR display for number and date inputs for consistency (FIX for Urdu environment) */
        input[type="number"], input[type="date"] {
            direction: ltr; /* Force LTR for number entry */
            text-align: left; /* Aligns input value/placeholder left */
        }
        /* Ensure regular text inputs/selects stay RTL for Urdu */
        input[type="text"], select {
            text-align: right;
            direction: rtl; 
        }

        /* Basic RTL adjustments for text alignment */
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        /* Ensure inputs and buttons use appropriate text alignment */
        input[type="number"], input[type="date"], input[type="text"], select {
            /* Keep numbers LTR for easy entry, but allow text to be RTL */
            text-align: right;
        }
        
        /* Style for action buttons with hover effects */
        .action-btn {
            padding: 8px 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .action-btn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        /* Responsive table cell padding for mobile */
        @media (max-width: 640px) {
            .table-cell-padding {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Active tab styling */
        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 2px solid #3b82f6; /* Blue-500 */
            color: #1f2937; /* Dark text */
            font-weight: 700;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        /* Custom selector styling for better look */
        #month-selector {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 0.75rem center; /* Adjusted for RTL: left instead of right */
            padding-right: 2.5rem; /* Ensure space for the icon on the right (RTL) */
            padding-left: 0.75rem;
            background-size: 1.5rem;
            direction: ltr; /* Force LTR for the dropdown value */
            text-align: right;
        }
        /* Ensure the currency display is always LTR to show Rs. correctly */
        .currency-display {
            direction: ltr !important;
            text-align: right !important;
        }
        /* Style for date display to fix RTL issue */
        .date-display-wrapper {
             direction: ltr; /* Force LTR context for the number and English text */
             text-align: center; /* Center the entire block within its container */
        }
    </style>
    <!-- Load Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="p-4 sm:p-6 bg-gray-50 min-h-screen flex flex-col items-center">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/70 z-50 flex items-center justify-center hidden">
        <div class="flex items-center space-x-reverse space-x-2 text-gray-700 p-4 bg-white rounded-lg shadow-2xl">
            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Loading... Please wait. (Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’)</span>
        </div>
    </div>
    
    <!-- Custom Modal for Alerts and Messages -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Notification (Ø§Ø·Ù„Ø§Ø¹)</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close-btn" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 action-btn w-full">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal for Delete -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirm (ØªØµØ¯ÛŒÙ‚ Ú©Ø±ÛŒÚº)</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Are you sure you want to delete this record? (Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ)</p>
            <div class="flex justify-end space-x-reverse space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn flex-grow">Cancel</button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 action-btn flex-grow">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal (NEW) -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">User Profile (ØµØ§Ø±Ù Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª)</h3>
            <div class="space-y-3 mb-6 text-sm">
                <p class="text-gray-700">
                    <span class="font-semibold block">Login Type (Ù„Ø§Ú¯ Ø§ÙÙ† Ù‚Ø³Ù…):</span> 
                    <span id="profile-login-type" class="text-sm font-mono text-blue-600 break-all">...</span>
                </p>
                <p class="text-gray-700">
                    <span class="font-semibold block">Access Code (Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ):</span> 
                    <span id="profile-secret-key" class="text-xs font-mono text-gray-800 break-all">...</span>
                </p>
                <p id="shared-note" class="text-sm text-green-600 font-medium hidden">
                    All users with this code share the same record. (Ø§Ø³ Ú©ÙˆÚˆ Ú©Û’ ØªÙ…Ø§Ù… ØµØ§Ø±ÙÛŒÙ† Ø§ÛŒÚ© ÛÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ø´ÛŒØ¦Ø± Ú©Ø±ØªÛ’ ÛÛŒÚºÛ”)
                </p>
            </div>
            <button id="logout-btn" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 action-btn w-full">Logout (Ù„Ø§Ú¯ Ø¢Ø¤Ù¹)</button>
            <button id="profile-close-btn" class="bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn w-full mt-2">Close</button>
        </div>
    </div>

    
    <div class="max-w-4xl w-full">
        
        <header class="flex justify-between items-center mb-6 border-b pb-2">
            <!-- Centered Heading -->
            <h1 class="text-3xl font-bold text-gray-800 mx-auto">ğŸ¥› Milk Record Tracker (Google Sheets)</h1>
            <button id="profile-icon-btn" class="text-gray-600 hover:text-blue-600 p-2 rounded-full transition bg-white shadow-md absolute right-4 top-4 sm:right-6 sm:top-6">
                <span data-lucide="user" class="w-6 h-6"></span>
            </button>
        </header>

        <!-- --- LOGIN SCREEN (Shown initially) --- -->
        <div id="login-screen" class="p-6 bg-white rounded-xl shadow-xl max-w-md mx-auto mb-8 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Account Access (Ø§Ú©Ø§Ø¤Ù†Ù¹ ØªÚ© Ø±Ø³Ø§Ø¦ÛŒ)</h2>
            
            <!-- Login/Signup Tabs -->
            <div class="flex border-b border-gray-200 mb-4">
                <button id="tab-signup" class="tab-button active flex-1 p-3 text-center text-gray-700 rounded-tr-xl" onclick="switchLoginTab('signup')">
                    <span data-lucide="user-plus" class="w-5 h-5 inline-block ml-1"></span> Signup (Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù†)
                </button>
                <button id="tab-login" class="tab-button flex-1 p-3 text-center text-gray-700 rounded-tl-xl" onclick="switchLoginTab('login')">
                    <span data-lucide="log-in" class="w-5 h-5 inline-block ml-1"></span> Login (Ù„Ø§Ú¯ Ø§ÙÙ†)
                </button>
            </div>

            <!-- Signup Content -->
            <div id="signup-tab-content">
                <p class="text-gray-600 mb-4 text-center text-sm">
                    Create a unique Access Code (min 6 chars). This code links to your data in the Google Sheet. (Ø§ÛŒÚ© Ù…Ù†ÙØ±Ø¯ Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ (Ú©Ù… Ø§Ø² Ú©Ù… 6 Ø­Ø±ÙˆÙ) Ø¨Ù†Ø§Ø¦ÛŒÚºÛ” ÛŒÛ Ú©ÙˆÚˆ Ø¢Ù¾ Ú©Û’ ÚˆÛŒÙ¹Ø§ Ú©Ùˆ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒÙ¹ Ø³Û’ Ø¬ÙˆÚ‘ØªØ§ ÛÛ’Û”)
                </p>
                <form id="signup-form" class="space-y-4">
                    <div>
                        <label for="signup-key" class="block text-sm font-medium text-gray-700 mb-1">
                            New Access Code (Ù†ÛŒØ§ Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ)
                        </label>
                        <input type="text" id="signup-key" placeholder="e.g. MyFamilyDairy" required minlength="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" dir="ltr">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 action-btn text-center">
                        Signup (Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº)
                    </button>
                </form>
            </div>

             <!-- Login Content (Hidden Initially) -->
            <div id="login-tab-content" class="hidden">
                <p class="text-gray-600 mb-4 text-center text-sm">
                    Enter your existing Access Code. (Ø§Ù¾Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯Û Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”)
                </p>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="login-key" class="block text-sm font-medium text-gray-700 mb-1">
                                Access Code (Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ)
                            </label>
                            <input type="text" id="login-key" placeholder="e.g. MyFamilyDairy" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 action-btn text-center">
                            Login (Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚº)
                        </button>
                    </div>
                </form>
            </div>

            <p id="login-error-message" class="text-red-500 text-sm mt-3 text-center hidden">
                Login failed. Please try again.
            </p>

            <div class="mt-4 border-t pt-4">
                <button id="guest-access-btn" class="w-full bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 action-btn text-center">
                    Access as Guest (Ø¨ØºÛŒØ± Ú©ÙˆÚˆ Ú©Û’ Ø±Ø³Ø§Ø¦ÛŒ)
                </button>
            </div>
        </div>


        <!-- --- MAIN APP CONTENT (Hidden initially) --- -->
        <div id="main-app-content" class="hidden">
             <!-- Monthly Status Display and Selector (IMPROVED LOOK) -->
             <div class="flex flex-col sm:flex-row-reverse justify-between items-center gap-3 mb-6 p-4 bg-white rounded-xl shadow-md border-b-4 border-blue-500/10">
                <!-- Month Selector (aligned left in LTR context, visually right in RTL container) -->
                <select id="month-selector" class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 hover:bg-gray-100 cursor-pointer shadow-inner focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" onchange="handleMonthChange(this.value)">
                    <!-- Options will be injected by JavaScript -->
                </select>
                <!-- Data Display (aligned right in LTR context, visually left in RTL container) -->
                <p class="text-center text-lg font-bold text-gray-800 whitespace-nowrap date-display-wrapper">
                    Data for: <b id="current-month-display">...</b>
                </p>
            </div>

            <!-- Summary Cards (Updated for 4 metrics: Milk, Days, Balance, Absence) -->
            <div id="summary-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
                
                <!-- Milk -->
                <div class="bg-indigo-100 p-4 rounded-xl shadow-lg border-2 border-indigo-200 flex flex-col items-center text-center">
                    <span data-lucide="droplet" class="w-8 h-8 text-indigo-500 mx-auto mb-2"></span>
                    <div class="text-indigo-800 font-bold text-base sm:text-lg">
                        Milk 
                        <span class="block text-sm font-normal">(Ø¯ÙˆØ¯Ú¾)</span>
                    </div>
                    <div id="total-milk" class="text-xl sm:text-2xl font-extrabold text-indigo-900 mt-1">0.00 Litres</div>
                </div>
                
                <!-- Attendance -->
                <div class="bg-lime-100 p-4 rounded-xl shadow-lg border-2 border-lime-200 flex flex-col items-center text-center">
                    <span data-lucide="calendar" class="w-8 h-8 text-lime-600 mx-auto mb-2"></span>
                    <div class="text-lime-800 font-bold text-base sm:text-lg">
                        Attendance 
                        <span class="block text-sm font-normal">(Ø­Ø§Ø¶Ø±ÛŒ)</span>
                    </div>
                    <div id="total-days" class="text-xl sm:text-2xl font-extrabold text-lime-900 mt-1">0 Days</div>
                </div>

                <!-- Absence -->
                <div class="bg-rose-100 p-4 rounded-xl shadow-lg border-2 border-rose-200 flex flex-col items-center text-center">
                    <span data-lucide="x-circle" class="w-8 h-8 text-rose-500 mx-auto mb-2"></span>
                    <div class="text-rose-800 font-bold text-base sm:text-lg">
                        Absence 
                        <span class="block text-sm font-normal">(ØºÛŒØ± Ø­Ø§Ø¶Ø±ÛŒ)</span>
                    </div>
                    <div id="total-absent" class="text-xl sm:text-2xl font-extrabold text-rose-900 mt-1">0 Days</div>
                </div>

                <!-- Amount (Net Balance) -->
                <div id="balance-card" class="bg-red-100 p-4 rounded-xl shadow-lg border-2 border-red-300 flex flex-col items-center text-center">
                    <!-- Using banknote icon for generic currency -->
                    <span data-lucide="banknote" class="w-8 h-8 text-red-600 mx-auto mb-2"></span>
                    <!-- Label will be set dynamically in JS (Amount / Credit Advance) -->
                    <div class="text-red-800 font-bold text-base sm:text-lg" id="balance-label-wrapper">
                        Amount 
                        <span class="block text-sm font-normal">(Ø±Ù‚Ù…)</span>
                    </div>
                    <div id="net-balance" class="text-xl sm:text-2xl font-extrabold text-red-800 mt-1 currency-display">Rs. 0</div>
                </div>
            </div>
            
            <!-- Tabbed Entry Forms (New Compact Design) -->
            <div class="bg-white rounded-xl shadow-xl mb-8">
                <!-- Tab Buttons -->
                <div class="flex border-b border-gray-200">
                    <button id="tab-milk" class="tab-button active flex-1 p-3 text-center text-gray-700 rounded-tr-xl" onclick="switchAppTab('milk')">
                        <span data-lucide="droplet" class="w-5 h-5 inline-block ml-1"></span> Milk Entry
                    </button>
                    <button id="tab-payment" class="tab-button flex-1 p-3 text-center text-gray-700 rounded-tl-xl" onclick="switchAppTab('payment')">
                        <span data-lucide="wallet" class="w-5 h-5 inline-block ml-1"></span> Payment Entry
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="milk-tab-content" class="tab-content p-6">
                    <h2 id="milk-form-title" class="text-xl font-bold text-gray-700 mb-4">Milk Entry (Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬)</h2>
                    <form id="milk-entry-form" class="space-y-4">
                        <input type="hidden" id="milk-entry-id">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Date Input -->
                            <div>
                                <label for="milk-entry-date" class="block text-sm font-medium text-gray-700 mb-1">Date (ØªØ§Ø±ÛŒØ®)</label>
                                <input type="date" id="milk-entry-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>

                            <!-- Quantity Input -->
                            <div class="flex flex-col space-y-2">
                                <label for="milk-entry-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity (Ù…Ù‚Ø¯Ø§Ø± - Litres)</label>
                                <div class="flex space-x-reverse space-x-2">
                                    <input type="number" id="milk-entry-quantity" required min="0" step="0.01" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                                    <button type="button" id="absent-btn" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 action-btn text-sm whitespace-nowrap">
                                        Absent (ØºÛŒØ± Ø­Ø§Ø¶Ø±)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 action-btn">
                            Submit Milk Entry
                        </button>
                        <button type="button" id="milk-cancel-edit-btn" class="w-full bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn hidden">
                            Cancel Edit
                        </button>
                    </form>
                </div>

                <div id="payment-tab-content" class="tab-content p-6 hidden">
                    <h2 id="payment-form-title" class="text-xl font-bold text-gray-700 mb-4">Payment Entry (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬)</h2>
                    <form id="payment-entry-form" class="space-y-4">
                        <input type="hidden" id="payment-entry-id">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Date Input -->
                            <div>
                                <label for="payment-entry-date" class="block text-sm font-medium text-gray-700 mb-1">Date (ØªØ§Ø±ÛŒØ®)</label>
                                <input type="date" id="payment-entry-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>

                            <!-- Amount Input -->
                            <div>
                                <label for="payment-entry-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (Ø±Ù‚Ù… - Rupees)</label>
                                <input type="number" id="payment-entry-amount" required min="1" step="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-orange-600 text-white p-3 rounded-lg font-semibold hover:bg-orange-700 action-btn">
                            Submit Payment Entry
                        </button>
                        <button type="button" id="payment-cancel-edit-btn" class="w-full bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn hidden">
                            Cancel Edit
                        </button>
                    </form>
                </div>
            </div>

            <!-- Settings Section (Price Adjustment) - KEPT COLLAPSIBLE -->
            <div class="bg-white p-5 rounded-xl shadow-xl mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('settings-content').classList.toggle('hidden'); document.querySelector('#settings-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700">Settings (ØªØ±ØªÛŒØ¨Ø§Øª)</h2>
                    <span id="settings-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="settings-content" class="hidden pt-2 border-t mt-2 space-y-4">
                    <!-- Price Setting -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Milk Price (Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ Ù‚ÛŒÙ…Øª)</h3>
                        <label for="price-per-unit" class="block text-sm font-medium text-gray-700 mb-1">
                            Price Per Litre (ÙÛŒ Ù„ÛŒÙ¹Ø± Ù‚ÛŒÙ…Øª - Rupees):
                        </label>
                        <div class="flex space-x-reverse space-x-4">
                            <input type="number" id="price-per-unit" value="120" min="0" step="0.01" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            <button id="save-price-btn" class="bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 action-btn w-28">
                                Save Price
                            </button>
                        </div>
                        <p id="price-message" class="text-sm mt-2 hidden text-green-600"></p>
                    </div>

                    <!-- Milk Man Contact Setting (NEW) -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Milk Man Details (Ø¯ÙˆØ¯Ú¾ ÙˆØ§Ù„Û’ Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª)</h3>
                        <form id="milkman-details-form" class="space-y-3">
                            <div>
                                <label for="milkman-name" class="block text-sm font-medium text-gray-700 mb-1">Name (Ù†Ø§Ù…)</label>
                                <input type="text" id="milkman-name" placeholder="Milkman Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="milkman-contact" class="block text-sm font-medium text-gray-700 mb-1">Contact No. (Ø±Ø§Ø¨Ø·Û Ù†Ù…Ø¨Ø±)</label>
                                <input type="tel" id="milkman-contact" placeholder="+92 3XX XXXXXXX" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>
                            <button type="submit" id="save-milkman-btn" class="w-full bg-indigo-600 text-white p-2 rounded-lg font-semibold hover:bg-indigo-700 action-btn">
                                Save Details
                            </button>
                            <p id="milkman-message" class="text-sm mt-2 hidden text-green-600 text-center"></p>
                        </form>
                    </div>
                    <!-- PWA Installation Button (Manual Trigger) -->
                    <div id="pwa-install-container" class="border-t pt-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Install App (Ø§ÛŒÙ¾ Ø§Ù†Ø³Ù¹Ø§Ù„ Ú©Ø±ÛŒÚº)</h3>
                        <p class="text-gray-600 text-sm mb-3">Install this tracker to your device for fast offline access. (ÙÙˆØ±ÛŒ Ø¢Ù Ù„Ø§Ø¦Ù† Ø±Ø³Ø§Ø¦ÛŒ Ú©Û’ Ù„ÛŒÛ’ Ø§Ø³ Ù¹Ø±ÛŒÚ©Ø± Ú©Ùˆ Ø§Ù¾Ù†Û’ Ù…ÙˆØ¨Ø§Ø¦Ù„ Ù¾Ø± Ø§Ù†Ø³Ù¹Ø§Ù„ Ú©Ø±ÛŒÚºÛ”)</p>
                        <button id="install-button" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 action-btn flex items-center justify-center space-x-2 space-x-reverse">
                            <span data-lucide="download" class="w-5 h-5"></span>
                            <span>Install Milk Tracker</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Daily Records Table (FILTERED MONTH) -->
            <div class="bg-white p-6 rounded-xl shadow-xl mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('milk-records-content').classList.toggle('hidden'); document.querySelector('#milk-records-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700">Daily Records (Ù…Ù†ØªØ®Ø¨ Ù…ÛÛŒÙ†Û’ Ú©Ø§ Ø±ÛŒÚ©Ø§Ø±Úˆ)</h2>
                    <span id="milk-records-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="milk-records-content" class="pt-2 border-t mt-2">
                    <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Date (ØªØ§Ø±ÛŒØ®)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Quantity (Litres)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Amount (Rupees)</th>
                                    <th class="table-cell-padding px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="milk-records-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Milk Records will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Milk History Table (ALL OTHER MONTHS) -->
            <div class="bg-white p-6 rounded-xl shadow-xl mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('milk-history-content').classList.toggle('hidden'); document.querySelector('#milk-history-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700">Milk History (Ø¯ÙˆØ³Ø±Û’ Ù…ÛÛŒÙ†ÙˆÚº Ú©Ø§ Ø±ÛŒÚ©Ø§Ø±Úˆ)</h2>
                    <span id="milk-history-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="milk-history-content" class="hidden pt-2 border-t mt-2">
                    <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Date (ØªØ§Ø±ÛŒØ®)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Quantity (Litres)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Amount (Rupees)</th>
                                    <th class="table-cell-padding px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="milk-history-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Milk History Records will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment History Table (OVERALL HISTORY) -->
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('payment-records-content').classList.toggle('hidden'); document.querySelector('#payment-records-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700">Payment History (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªØ§Ø±ÛŒØ®)</h2>
                    <span id="payment-records-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="payment-records-content" class="pt-2 border-t mt-2">
                    <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Date (ØªØ§Ø±ÛŒØ®)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Amount Paid (Ø§Ø¯Ø§ Ú©Ø±Ø¯Û Ø±Ù‚Ù…)</th>
                                    <th class="table-cell-padding px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payment-records-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Payment Records will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div> <!-- End of main-app-content -->
    </div>

    <!-- 2. Service Worker Registration and PWA Logic -->
    <script>
        // Store deferred prompt for manual installation
        let deferredPrompt;
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installButton) {
                installButton.style.display = 'flex';
                document.getElementById('pwa-install-container').classList.remove('hidden');
            }
        });

        if (installButton) {
            installButton.addEventListener('click', (e) => {
                if (deferredPrompt) {
                    installButton.style.display = 'none';
                    deferredPrompt.prompt();
                    
                    deferredPrompt.userChoice.then((choiceResult) => {
                        console.log('User response to the install prompt:', choiceResult.outcome);
                        if (choiceResult.outcome === 'accepted') {
                            showModal('App installed successfully! Use the icon on your home screen.', 'Installation Success');
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
        
        // Service Worker Registration for Offline Capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:application/javascript;base64,J2xldCBjYWNoZU5hbWUgPSAnbWlsay10cmFja2VyLXUtY2FjaGUtMS4wJzsgCmNsZWFyQ2FjaGUoKTsgCgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCAoZSkgPT4gewogIGUud2FpdEZvcihjb2RlQ2FjaGVBbmRTY2lwV2FpdCgpKTsKfSk7IAoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmaXRjaCcsIChlKSA9PiB7CiAgLy8gR2V0IHRoZSByZXNwb25zZSBmcm9tIHRoZSBjYWNoZSBvciBmcm9tIHRoZSBuZXR3b3JrLgogIGUucmVzcG9uZE92ZXR0ZXJGaXhFcihcclxuICAgY2FjaGVzLmtldSgpCiAgLnRoZW4oY2FjaGVTdGF0aWNpZGRlcnMgPT4gewogICAgcmV0dXJuIGNhY2hlU3RhdGljaWRkZXJzLm1hdGNoKGUucmVxdWVzdCkuXHJcbiAgfSkgLi5zcmUoZGVmYXVsdEZpeGVyKVxyXG4gICk7Cn0pOwoKZnVuY3Rpb24gY2xlYXJDYWNoZSgpIHsKICBjYWNoZXMua2V5cygpLnRoZW4oY2FjaGVzID0+IHsKICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGNhY2hlcy5tYXBzKGNhY2hlID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUgIT09IGNhY2hlTmFtZSA/IGNhY2hlcy5kZWxldGUoY2FjaGUpIDogcHJvbWlzZS5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgfSk7Cn0KICAgCmZ1bmN0aW9uIGNvZGVDYWNoZUFkZEFuZFNjaXBWYWl0KCkgewogIHJldHVybiBjYWNoZXMuYWRkKGNhY2hlTmFtZSwgWwogICAgJy4vJywgLy8gQ2FjaGUgaW5kZXguY3NzIGFuZCBpbmRleC5odG1sCiAgICAnLi9pbmRleC5odG1sJywKICAgICdodHRwczovL2Nkbi50YWlsd2luZGNzcy5jb20vJywgLy8gQ2FjaGUgdGFpbHdpbmQgY2RuCiAgICAnaHR0cHM6Ly91bnBrZy5jb20vbHVjaWRlQGxhdGVzdCcsIC8vIENhY2hlIGx1Y2lkZSBpY29ucwogICAgJy8nCiAgXSk7Cn0KCmZ1bmN0aW9uIGRlZmF1bHRGaXhlcigpIHsKICBldmVudC5yZXNwb25kZShmZXRjaChldmVudC5yZXF1ZXN0KSk7CiAgcmV0dXJuOwp9Cg==');
            });
        }
    </script>
    

    <!-- --- GOOGLE SHEETS / APPS SCRIPT INTEGRATION LOGIC --- -->
    <script type="module">
        
        // IMPORTANT: Replace this with your deployed Google Apps Script Web App URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYhd1QKZx-AylUQqXOFeu6qRCs8XJx1Rr2lw-vN-ax15iGGNqU7j1zTMsM025CuyBX7w/exec'; // *** MUST BE REPLACED ***
        const GUEST_KEY = 'GUEST_MODE'; 
        const POLLING_INTERVAL = 5000; // Check for updates every 5 seconds (to simulate real-time)

        // --- GLOBAL STATE ---
        let groupKey = null; // The Access Code used for logging in (or GUEST_MODE)
        let isAuthReady = false;
        
        // Data State (will be replaced by fetched data)
        let milkRecords = []; 
        let paymentRecords = [];
        let pricePerUnit = 120;
        let milkmanName = '';
        let milkmanContact = '';

        let currentFilterMonth = getCurrentMonthYearString(); // Default to current month YYYY-MM
        let dataPollingTimer = null; // For simulating real-time updates

        // --- ELEMENTS (Identical to original) ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const totalMilkEl = document.getElementById('total-milk');
        const netBalanceEl = document.getElementById('net-balance');
        const balanceCard = document.getElementById('balance-card');
        const totalDaysEl = document.getElementById('total-days');
        const totalAbsentEl = document.getElementById('total-absent'); 
        const milkRecordsTableBody = document.getElementById('milk-records-table-body');
        const milkHistoryTableBody = document.getElementById('milk-history-table-body');
        const paymentRecordsTableBody = document.getElementById('payment-records-table-body');
        const pricePerUnitInput = document.getElementById('price-per-unit');
        const savePriceBtn = document.getElementById('save-price-btn');
        const priceMessageEl = document.getElementById('price-message');
        const monthSelector = document.getElementById('month-selector');
        
        const milkEntryForm = document.getElementById('milk-entry-form');
        const milkFormTitleEl = document.getElementById('milk-form-title');
        const milkCancelEditBtn = document.getElementById('milk-cancel-edit-btn');
        const absentBtn = document.getElementById('absent-btn'); 
        
        const paymentEntryForm = document.getElementById('payment-entry-form');
        const paymentFormTitleEl = document.getElementById('payment-form-title');
        const paymentCancelEditBtn = document.getElementById('payment-cancel-edit-btn');
        
        // Login UI elements
        const loginScreen = document.getElementById('login-screen'); 
        const mainAppContent = document.getElementById('main-app-content'); 
        
        const signupForm = document.getElementById('signup-form');
        const signupKeyInput = document.getElementById('signup-key');
        
        const loginForm = document.getElementById('login-form'); 
        const loginKeyInput = document.getElementById('login-key');
        
        const loginErrorMsg = document.getElementById('login-error-message');
        const guestAccessBtn = document.getElementById('guest-access-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        
        // Profile Modal elements
        const profileIconBtn = document.getElementById('profile-icon-btn');
        const profileModal = document.getElementById('profile-modal');
        const profileCloseBtn = document.getElementById('profile-close-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileLoginType = document.getElementById('profile-login-type');
        const profileSecretKey = document.getElementById('profile-secret-key');
        const sharedNote = document.getElementById('shared-note'); // NOTE: Removed profile-session-id as there is no Firebase UID

        // Milkman Settings Elements
        const milkmanNameInput = document.getElementById('milkman-name');
        const milkmanContactInput = document.getElementById('milkman-contact');
        const milkmanDetailsForm = document.getElementById('milkman-details-form');
        const milkmanMessageEl = document.getElementById('milkman-message');

        // Modal elements 
        const customModal = document.getElementById('custom-modal');
        const modalMessageEl = document.getElementById('modal-message');
        const modalTitleEl = document.getElementById('modal-title');
        const modalCloseBtn = document.getElementById('modal-close-btn'); 
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn'); 
        const confirmYesBtn = document.getElementById('confirm-yes-btn'); 

        // --- UI UTILITIES (Identical) ---

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function showModal(message, title = 'Notification (Ø§Ø·Ù„Ø§Ø¹)') {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            customModal.classList.remove('hidden');
        }

        // --- LOGIN TAB SWITCHING (Identical) ---
        window.switchLoginTab = (tabName) => {
            document.querySelectorAll('#login-screen .tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('signup-tab-content').classList.add('hidden');
            document.getElementById('login-tab-content').classList.add('hidden');
            loginErrorMsg.classList.add('hidden'); // Clear previous errors

            if (tabName === 'signup') {
                document.getElementById('tab-signup').classList.add('active');
                document.getElementById('signup-tab-content').classList.remove('hidden');
            } else if (tabName === 'login') {
                document.getElementById('tab-login').classList.add('active');
                document.getElementById('login-tab-content').classList.remove('hidden');
            }
        }
        
        // --- APP TAB SWITCHING (Identical) ---
        window.switchAppTab = (tabName) => {
            document.querySelectorAll('#main-app-content .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            if (tabName === 'milk') {
                document.getElementById('tab-milk').classList.add('active');
                document.getElementById('milk-tab-content').classList.remove('hidden');
            } else if (tabName === 'payment') {
                document.getElementById('tab-payment').classList.add('active');
                document.getElementById('payment-tab-content').classList.remove('hidden');
            }
            // Ensure no edit mode is active when switching tabs
            resetMilkForm();
            resetPaymentForm();
            lucide.createIcons();
        }
        
        // --- PROFILE MODAL HANDLERS (Adjusted for no Firebase UID) ---
        function showProfileModal() {
            if (!isAuthReady) return;
            
            // Removed profileSessionId logic as there is no Firebase UID
            
            if (groupKey === GUEST_KEY) {
                profileLoginType.textContent = 'Guest Mode (Ù…ÛÙ…Ø§Ù† Ù…ÙˆÚˆ)';
                profileSecretKey.textContent = 'None (Ú©ÙˆØ¦ÛŒ Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ Ù†ÛÛŒÚº)';
                sharedNote.classList.add('hidden');
            } else {
                profileLoginType.textContent = 'Shared Record (Ù…Ø´ØªØ±Ú©Û Ø±ÛŒÚ©Ø§Ø±Úˆ)';
                profileSecretKey.textContent = groupKey; 
                sharedNote.classList.remove('hidden');
            }
            profileModal.classList.remove('hidden');
        }

        function closeProfileModal() {
            profileModal.classList.add('hidden');
        }
        
        function handleLogout() {
            // Clear local state and reset UI (no need for Firebase signOut)
            localStorage.removeItem('milk_tracker_type');
            localStorage.removeItem('milk_tracker_key');
            resetAppUI();
        }

        function resetAppUI() {
            isAuthReady = false;
            groupKey = null;
            clearInterval(dataPollingTimer); // Stop data polling!
            milkRecords = []; 
            paymentRecords = [];
            pricePerUnit = 120;
            currentFilterMonth = getCurrentMonthYearString();
            
            // Clear UI
            renderMilkTable([], milkRecordsTableBody, true); 
            renderMilkTable([], milkHistoryTableBody, false);
            renderPaymentRecords();

            loginScreen.classList.remove('hidden');
            mainAppContent.classList.add('hidden');
            closeProfileModal();
            resetMilkForm();
            resetPaymentForm();
        }

        // --- APPS SCRIPT API HELPER ---

        async function callApi(action, data = {}, method = 'POST') {
            if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
                showModal('Please replace "YOUR_DEPLOYED_WEB_APP_URL_HERE" in the JavaScript code with your actual Apps Script Web App URL.', 'API Error: Setup Required');
                return { success: false, message: 'API URL not set.' };
            }
            
            const payload = { action, key: groupKey, ...data };
            let response;
            
            try {
                response = await fetch(APPS_SCRIPT_URL, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors'
                });

                if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success === false) {
                     // The script executed, but the operation failed (e.g., bad data, file access denied)
                     throw new Error(result.message || 'Unknown operation error from server.');
                }
                
                return result;

            } catch (error) {
                console.error("API Call Failed:", error);
                showModal(`Server Error (${action}): ${error.message || 'Network issue/Script not deployed correctly.'}`, 'Connection Error');
                return { success: false, message: error.message };
            }
        }
        
        // --- AUTHENTICATION FLOW (Simulated with LocalStorage/API Check) ---
        
        async function checkKeyExists(key) {
            if (key === GUEST_KEY) return { exists: true };
            
            const result = await callApi('CHECK_KEY', { newKey: key }, 'POST');
            return result; // result.exists will be true or false
        }

        async function handleAccess(key, type) {
            showLoading();
            loginErrorMsg.classList.add('hidden');
            let success = false;
            let targetGroupKey = key ? key.trim().toLowerCase() : GUEST_KEY;

            try {
                if (type === 'guest') {
                    success = true; // Guest mode access is always successful
                } else if (type === 'signup') {
                    if (targetGroupKey.length < 6) {
                        loginErrorMsg.textContent = 'Access Code must be at least 6 characters long. (Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ Ú©Ù… Ø§Ø² Ú©Ù… 6 Ø­Ø±ÙˆÙ Ú©Ø§ ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’)';
                        hideLoading();
                        return;
                    }
                    const checkResult = await checkKeyExists(targetGroupKey);
                    if (checkResult.exists) {
                        loginErrorMsg.textContent = 'Signup failed. This code is already taken. Please Login. (Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù† Ù†Ø§Ú©Ø§Ù…Û” ÛŒÛ Ú©ÙˆÚˆ Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚºÛ”)';
                    } else {
                        // Success! The key does not exist, proceed to register/login
                        success = true; 
                    }
                } else if (type === 'login') {
                    const checkResult = await checkKeyExists(targetGroupKey);
                    if (checkResult.exists) {
                        success = true;
                    } else {
                        loginErrorMsg.textContent = 'Login failed. Code not found. Please Signup first. (Ù„Ø§Ú¯ Ø§ÙÙ† Ù†Ø§Ú©Ø§Ù…Û” Ú©ÙˆÚˆ Ù†ÛÛŒÚº Ù…Ù„Ø§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ù¾ÛÙ„Û’ Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù† Ú©Ø±ÛŒÚºÛ”)';
                    }
                }

                if (success) {
                    groupKey = targetGroupKey;
                    
                    // Save state locally
                    localStorage.setItem('milk_tracker_type', groupKey === GUEST_KEY ? 'guest' : 'shared');
                    if (groupKey !== GUEST_KEY) {
                        localStorage.setItem('milk_tracker_key', groupKey);
                    } else {
                        localStorage.removeItem('milk_tracker_key');
                    }
                    
                    // Proceed to app UI
                    loginScreen.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                    isAuthReady = true; 
                    startDataPolling(); // Start fetching data periodically
                    
                } else {
                    loginErrorMsg.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error("Access failed:", error);
                loginErrorMsg.textContent = `Access error: ${error.message}`;
                loginErrorMsg.classList.remove('hidden');
                resetAppUI(); 
            } finally {
                hideLoading();
            }
        }


        function checkLocalAuth() {
            const storedType = localStorage.getItem('milk_tracker_type');
            const storedKey = localStorage.getItem('milk_tracker_key');
            
            if (storedType === 'guest') {
                groupKey = GUEST_KEY;
                return true;
            } else if (storedType === 'shared' && storedKey) {
                groupKey = storedKey;
                return true;
            }
            return false;
        }

        function initializeApp() {
            showLoading();
            
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            document.getElementById('milk-entry-date').value = todayISO;
            document.getElementById('payment-entry-date').value = todayISO;

            if (checkLocalAuth()) {
                // Resume session
                loginScreen.classList.add('hidden');
                mainAppContent.classList.remove('hidden');
                isAuthReady = true; 
                startDataPolling();
            } else {
                // Show login screen
                resetAppUI();
                loginScreen.classList.remove('hidden');
                hideLoading();
            }
            
            populateMonthSelector();
        }
        
        function startDataPolling() {
            if (dataPollingTimer) clearInterval(dataPollingTimer);
            
            // Immediate fetch upon login
            fetchData(); 
            
            // Set up interval for repeated fetching
            dataPollingTimer = setInterval(fetchData, POLLING_INTERVAL);
        }

        async function fetchData() {
            if (!isAuthReady || !groupKey) return; 

            try {
                const result = await callApi('GET_ALL_DATA', { key: groupKey }, 'POST');
                
                if (result.success) {
                    // Update all state variables based on API response
                    milkRecords = result.milkRecords || [];
                    paymentRecords = result.paymentRecords || [];
                    pricePerUnit = parseFloat(result.settings.pricePerUnit) || 120;
                    milkmanName = result.settings.milkmanName || '';
                    milkmanContact = result.settings.milkmanContact || '';

                    // Update UI elements
                    pricePerUnitInput.value = pricePerUnit.toFixed(2);
                    milkmanNameInput.value = milkmanName;
                    milkmanContactInput.value = milkmanContact;
                    
                    // Sort data by date/timestamp (descending) 
                    milkRecords.sort((a, b) => b.date.localeCompare(a.date) || b.timestamp - a.timestamp);
                    paymentRecords.sort((a, b) => b.date.localeCompare(a.date) || b.timestamp - a.timestamp);

                    renderMilkRecords();
                    renderPaymentRecords();
                    updateSummary();
                }

            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }
        
        // --- LOGIN/SIGNUP Form Handlers (Identical calls, modified implementations) ---

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const key = signupKeyInput.value;
            if (key.trim()) {
                handleAccess(key, 'signup');
            } else {
                 loginErrorMsg.textContent = 'Please enter an Access Code. (Ø¨Ø±Ø§Ø¦Û’ Ù…ÛØ±Ø¨Ø§Ù†ÛŒ Ø§ÛŒÚ© Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”)';
                 loginErrorMsg.classList.remove('hidden');
            }
        });
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const key = loginKeyInput.value;
            if (key.trim()) {
                handleAccess(key, 'login'); 
            } else {
                 loginErrorMsg.textContent = 'Please enter your Access Code. (Ø¨Ø±Ø§Ø¦Û’ Ù…ÛØ±Ø¨Ø§Ù†ÛŒ Ø§Ù¾Ù†Ø§ Ø±Ø³Ø§Ø¦ÛŒ Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”)';
                 loginErrorMsg.classList.remove('hidden');
            }
        });

        guestAccessBtn.addEventListener('click', () => {
             handleAccess(null, 'guest'); 
        });

        
        // --- SETTINGS HANDLING (Price and Milkman - Uses API) ---

        savePriceBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                showModal('Please login to save settings. (ØªØ±ØªÛŒØ¨Ø§Øª Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚºÛ”)');
                return;
            }
            
            const newPrice = parseFloat(pricePerUnitInput.value);
            if (isNaN(newPrice) || newPrice < 0) {
                priceMessageEl.textContent = 'Please enter a valid price. (Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯Ø±Ø³Øª Ù‚ÛŒÙ…Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”)';
                priceMessageEl.classList.remove('text-green-600', 'hidden');
                priceMessageEl.classList.add('text-red-600');
                return;
            }
            
            showLoading();
            try {
                const result = await callApi('UPDATE_SETTINGS', { pricePerUnit: newPrice }, 'POST');

                if (result.success) {
                    priceMessageEl.textContent = 'Price saved successfully! (Ù‚ÛŒÙ…Øª Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ù…Ø­ÙÙˆØ¸ Ú©Ø± Ù„ÛŒ Ú¯Ø¦ÛŒ!)';
                    priceMessageEl.classList.remove('text-red-600', 'hidden');
                    priceMessageEl.classList.add('text-green-600');
                    fetchData(); // Refresh all data including summary
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Error saving price:", error);
                showModal(`Failed to save Price. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
                setTimeout(() => priceMessageEl.classList.add('hidden'), 3000);
            }
        });

        milkmanDetailsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showModal('Please login to save settings. (ØªØ±ØªÛŒØ¨Ø§Øª Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚºÛ”)');
                return;
            }
            
            const milkmanName = milkmanNameInput.value.trim();
            const milkmanContact = milkmanContactInput.value.trim();
            
            showLoading();
            try {
                const result = await callApi('UPDATE_SETTINGS', { milkmanName, milkmanContact }, 'POST');

                if (result.success) {
                    milkmanMessageEl.textContent = 'Milkman details saved successfully! (Ø¯ÙˆØ¯Ú¾ ÙˆØ§Ù„Û’ Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª Ù…Ø­ÙÙˆØ¸ Ú©Ø± Ù„ÛŒ Ú¯Ø¦ÛŒ!)';
                    milkmanMessageEl.classList.remove('text-red-600', 'hidden');
                    milkmanMessageEl.classList.add('text-green-600');
                    fetchData(); // Refresh to ensure state is updated
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Error saving milkman details:", error);
                showModal(`Failed to save Milkman details. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
                setTimeout(() => milkmanMessageEl.classList.add('hidden'), 3000);
            }
        });


        // --- MONTH SELECTOR AND FILTERING LOGIC (Identical) ---
        
        function populateMonthSelector() {
            const today = new Date();
            let optionsHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const monthYearKey = `${year}-${month}`;
                
                const displayDate = getMonthName(monthYearKey + '-01'); 
                const isSelected = monthYearKey === currentFilterMonth ? 'selected' : '';
                
                optionsHTML += `<option value="${monthYearKey}" ${isSelected}>${displayDate}</option>`;
            }
            monthSelector.innerHTML = optionsHTML;
        }
        
        window.handleMonthChange = (selectedMonthYear) => {
            currentFilterMonth = selectedMonthYear;
            updateSummary();
            renderMilkRecords();

            const milkRecordsContent = document.getElementById('milk-records-content');
            if (milkRecordsContent.classList.contains('hidden')) {
                milkRecordsContent.classList.remove('hidden');
                document.querySelector('#milk-records-icon').classList.remove('rotate-180');
            }
        }
        
        function getMonthName(dateStr) {
            const date = new Date(dateStr); 
            if (isNaN(date)) return 'N/A';
            
            try {
                const options = { month: 'long', year: 'numeric' };
                return date.toLocaleString('ur-PK', options);
            } catch (e) {
                console.error("Urdu date formatting failed:", e);
                return date.getFullYear();
            }
        }

        function getCurrentMonthYearString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            return `${year}-${month}`;
        }
        
        // --- SUMMARY & RENDERING (Identical, relies on global state being updated by fetchData) ---

        function updateSummary() {
            const filterMonthYear = currentFilterMonth;
            
            // 1. Update Current Month Display (Selected Month)
            const displayDate = filterMonthYear + '-01'; 
            const currentMonthName = getMonthName(displayDate);
            if (currentMonthDisplay) currentMonthDisplay.innerHTML = `<b>${currentMonthName}</b>`;

            // 2. Filter records for the SELECTED MONTH only (YYYY-MM)
            const filteredMilkRecords = milkRecords.filter(r => r.date && r.date.startsWith(filterMonthYear));

            // 3. Calculate Total Milk (Filtered) - SELECTED MONTH MILK
            const totalMilkCurrentMonth = filteredMilkRecords.reduce((sum, record) => sum + (parseFloat(record.quantity) || 0), 0);

            // 4. Calculate Total Payments Made (Overall - NO FILTERING)
            const overallPaymentsMade = paymentRecords.reduce((sum, record) => sum + (parseFloat(record.amount) || 0), 0);
            
            // 5. Calculate Net Balance (Overall Milk Price - Overall Payments)
            const overallMilkPrice = milkRecords.reduce((sum, record) => sum + (parseFloat(record.quantity) || 0), 0) * pricePerUnit;
            const netBalanceDue = overallMilkPrice - overallPaymentsMade;
            
            // 6. Calculate Active Days (Only count days where quantity > 0)
            const activeDays = filteredMilkRecords.filter(r => parseFloat(r.quantity) > 0);
            const totalActiveDays = new Set(activeDays.map(r => r.date)).size; 
            
            // 7. Calculate Total Absence Days (Where isAbsent is explicitly true)
            const totalAbsenceDays = filteredMilkRecords.filter(r => r.isAbsent === true).length;

            // 8. Update UI Metrics
            if (totalMilkEl) totalMilkEl.textContent = `${totalMilkCurrentMonth.toFixed(2)} Litres`;
            if (totalDaysEl) totalDaysEl.textContent = `${totalActiveDays} Days`;
            if (totalAbsentEl) totalAbsentEl.textContent = `${totalAbsenceDays} Days`; 
            
            if (!balanceCard || !netBalanceEl) { 
                lucide.createIcons();
                return;
            }

            const formattedAmount = Math.round(Math.abs(netBalanceDue)).toLocaleString('ur-PK');
            netBalanceEl.textContent = `Rs. ${formattedAmount}`; 

            // Update Balance Card color (Green for Credit, Red for Due)
            const banknoteIcon = balanceCard.querySelector('span[data-lucide="banknote"]');
            const balanceLabelWrapper = document.getElementById('balance-label-wrapper');

            if (netBalanceDue > 0) {
                // Money is DUE (Red-600/900) - Distinct from Rose-500/900
                balanceCard.className = 'bg-red-100 p-4 rounded-xl shadow-lg border-2 border-red-300 flex flex-col items-center text-center';
                banknoteIcon.className = 'w-8 h-8 text-red-600 mx-auto mb-2';
                balanceLabelWrapper.innerHTML = `Amount <span class="block text-sm font-normal">(Ø±Ù‚Ù…)</span>`;
                netBalanceEl.className = 'text-xl sm:text-2xl font-extrabold text-red-800 mt-1 currency-display';
            } else {
                // Money is CREDIT/Advance (Green)
                balanceCard.className = 'bg-emerald-100 p-4 rounded-xl shadow-lg border-2 border-emerald-200 flex flex-col items-center text-center';
                banknoteIcon.className = 'w-8 h-8 text-emerald-500 mx-auto mb-2';
                balanceLabelWrapper.innerHTML = `Credit Advance <span class="block text-sm font-normal">(Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø±Ù‚Ù…)</span>`;
                netBalanceEl.className = 'text-xl sm:text-2xl font-extrabold text-emerald-900 mt-1 currency-display';
            }
        }
        
        function renderMilkRecords() {
            const filterMonthYear = currentFilterMonth;
            const currentMonthYear = getCurrentMonthYearString();

            // Records filtered by the selected month (Daily Records Table)
            const filteredRecords = milkRecords.filter(r => r.date && r.date.startsWith(filterMonthYear));
            
            // Only allow editing/deleting if the selected month is the actual current month
            const isSelectedMonthCurrent = filterMonthYear === currentMonthYear;
            renderMilkTable(filteredRecords, milkRecordsTableBody, isSelectedMonthCurrent); 

            // Records NOT included in the selected month (Milk History Table)
            // Show only records that belong to months BEFORE the currently selected month
            const historyRecords = milkRecords.filter(r => r.date && r.date.localeCompare(filterMonthYear) < 0);
            renderMilkTable(historyRecords, milkHistoryTableBody, false); // History records are always view-only

            lucide.createIcons();
        }

        function renderMilkTable(recordsToRender, tableBodyEl, isEditable) {
            tableBodyEl.innerHTML = '';
            if (recordsToRender.length === 0) {
                const colspan = 4;
                let message;
                if (isEditable) {
                    message = currentFilterMonth === getCurrentMonthYearString() 
                        ? 'Start adding records for this month.' 
                        : 'No records found for the selected month.';
                } else {
                    message = 'No older records found.';
                }

                tableBodyEl.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4 text-gray-500">${message} (Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº Ù…Ù„Ø§)</td></tr>`;
                return;
            }

            recordsToRender.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const quantity = parseFloat(record.quantity) || 0;
                const payment = (quantity * pricePerUnit);
                const dateParts = record.date.split('-'); // YYYY-MM-DD
                const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; // DD/MM/YYYY
                
                let quantityDisplay;
                let rowClasses = '';
                if (record.isAbsent === true || record.isAbsent === 'TRUE') { // Check for string 'TRUE' from Apps Script
                    quantityDisplay = `<span class="font-bold text-red-600">ABSENT (ØºÛŒØ± Ø­Ø§Ø¶Ø±)</span>`;
                    rowClasses = 'bg-red-50/50';
                } else {
                    quantityDisplay = `<span dir="ltr">${quantity.toFixed(2)}</span>`;
                }

                const actionButtons = isEditable ? `
                    <button onclick="window.editMilkRecord('${record.id}')" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-100 transition">
                        <span data-lucide="square-pen" class="w-4 h-4 inline-block"></span>
                        <span class="hidden sm:inline-block">Edit</span>
                    </button>
                    <button onclick="window.prepareDeleteRecord('${record.id}', 'milk')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition ml-2">
                        <span data-lucide="trash-2" class="w-4 h-4 inline-block"></span>
                        <span class="hidden sm:inline-block">Delete</span>
                    </button>
                ` : '<span class="text-gray-400">View Only</span>';

                const displayAmount = `Rs. ${Math.round(payment).toLocaleString('ur-PK')}`;

                row.innerHTML = `
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm text-gray-800 ${rowClasses}">${displayDate}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 ${rowClasses}">${quantityDisplay}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm text-gray-800 ${rowClasses} currency-display">${displayAmount}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-center text-sm font-medium ${rowClasses}">
                        ${actionButtons}
                    </td>
                `;
                tableBodyEl.appendChild(row);
            });
        }

        function renderPaymentRecords() {
            const recordsToRender = paymentRecords; 

            paymentRecordsTableBody.innerHTML = '';
            if (recordsToRender.length === 0) {
                paymentRecordsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No payment history found. (Ú©ÙˆØ¦ÛŒ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ù†ÛÛŒÚº Ù…Ù„ÛŒ)</td></tr>';
                return;
            }

            recordsToRender.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const amount = parseFloat(record.amount) || 0;
                const dateParts = record.date.split('-'); // YYYY-MM-DD
                const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; // DD/MM/YYYY
                const displayAmount = `Rs. ${Math.round(amount).toLocaleString('ur-PK')}`;

                row.innerHTML = `
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm text-gray-800">${displayDate}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 currency-display">${displayAmount}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="window.editPaymentRecord('${record.id}')" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-100 transition">
                            <span data-lucide="square-pen" class="w-4 h-4 inline-block"></span>
                            <span class="hidden sm:inline-block">Edit</span>
                        </button>
                        <button onclick="window.prepareDeleteRecord('${record.id}', 'payment')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition ml-2">
                            <span data-lucide="trash-2" class="w-4 h-4 inline-block"></span>
                            <span class="hidden sm:inline-block">Delete</span>
                        </button>
                    </td>
                `;
                paymentRecordsTableBody.appendChild(row);
            });
            lucide.createIcons();
        }

        // --- EXPOSED WINDOW FUNCTIONS (for table buttons - Identical calls, modified implementations) ---

        window.editMilkRecord = (id) => {
            const record = milkRecords.find(r => r.id == id); // Use == for comparison as ID might be string/number
            if (record) {
                switchAppTab('milk');

                document.getElementById('milk-entry-id').value = record.id;
                document.getElementById('milk-entry-date').value = record.date;
                document.getElementById('milk-entry-quantity').value = parseFloat(record.quantity).toFixed(2);
                
                milkFormTitleEl.textContent = 'Edit Milk Entry (Ø¯ÙˆØ¯Ú¾ Ø§Ù†Ø¯Ø±Ø§Ø¬ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ…)';
                milkEntryForm.querySelector('button[type="submit"]').textContent = 'Save Changes';
                milkEntryForm.querySelector('button[type="submit"]').classList.replace('bg-green-600', 'bg-blue-600');
                milkCancelEditBtn.classList.remove('hidden');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        milkCancelEditBtn.addEventListener('click', resetMilkForm);

        function resetMilkForm() {
            document.getElementById('milk-entry-id').value = '';
            milkEntryForm.reset();
            document.getElementById('milk-entry-date').valueAsDate = new Date(); // Reset date to today
            document.getElementById('milk-entry-quantity').value = '';
            milkFormTitleEl.textContent = 'Milk Entry (Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬)';
            milkEntryForm.querySelector('button[type="submit"]').textContent = 'Submit Milk Entry';
            milkEntryForm.querySelector('button[type="submit"]').classList.replace('bg-blue-600', 'bg-green-600');
            milkCancelEditBtn.classList.add('hidden');
        }
        
        absentBtn.addEventListener('click', () => {
            document.getElementById('milk-entry-quantity').value = '0.00';
            milkEntryForm.dataset.isAbsent = 'true'; 
            const submitBtn = milkEntryForm.querySelector('button[type="submit"]');
            submitBtn.click();
        });

        window.editPaymentRecord = (id) => {
            const record = paymentRecords.find(r => r.id == id);
            if (record) {
                switchAppTab('payment');

                document.getElementById('payment-entry-id').value = record.id;
                document.getElementById('payment-entry-date').value = record.date;
                document.getElementById('payment-entry-amount').value = parseFloat(record.amount).toFixed(0);
                
                paymentFormTitleEl.textContent = 'Edit Payment Entry (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ…)';
                paymentEntryForm.querySelector('button[type="submit"]').textContent = 'Save Changes';
                paymentEntryForm.querySelector('button[type="submit"]').classList.replace('bg-orange-600', 'bg-blue-600');
                paymentCancelEditBtn.classList.remove('hidden');

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        
        paymentCancelEditBtn.addEventListener('click', resetPaymentForm);

        function resetPaymentForm() {
            document.getElementById('payment-entry-id').value = '';
            paymentEntryForm.reset();
            document.getElementById('payment-entry-date').valueAsDate = new Date(); 
            document.getElementById('payment-entry-amount').value = '';
            paymentFormTitleEl.textContent = 'Payment Entry (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬)';
            paymentEntryForm.querySelector('button[type="submit"]').textContent = 'Submit Payment Entry';
            paymentEntryForm.querySelector('button[type="submit"]').classList.replace('bg-blue-600', 'bg-orange-600');
            paymentCancelEditBtn.classList.add('hidden');
        }


        let recordToDeleteId = null;
        let recordToDeleteType = null;

        window.prepareDeleteRecord = (id, type) => {
            recordToDeleteId = id;
            recordToDeleteType = type;
            const message = type === 'milk' 
                ? 'Are you sure you want to delete this <b>Milk Record</b>? (Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø¯ÙˆØ¯Ú¾ Ú©Û’ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ)'
                : 'Are you sure you want to delete this <b>Payment Record</b>? (Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Û’ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ)';
            document.getElementById('confirm-message').innerHTML = message;
            confirmationModal.classList.remove('hidden');
        };

        confirmCancelBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            recordToDeleteId = null;
            recordToDeleteType = null;
        });
        
        async function deleteRecordApi(id, type) {
            showLoading();
            try {
                const result = await callApi('DELETE_RECORD', { id, type }, 'POST');
                
                if (result.success) {
                    showModal(`${type === 'milk' ? 'Milk Record' : 'Payment Record'} deleted successfully. (Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”)`);
                    fetchData(); // Refresh data after delete
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error(`Error deleting ${type} record:`, error);
                showModal(`Failed to delete ${type} record. (Ø±ÛŒÚ©Ø§Ø±Úˆ Ø­Ø°Ù Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒÛ”) Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
            }
        }
        
        // --- FORM SUBMISSION HANDLERS (Uses API) ---

        milkEntryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || !groupKey) {
                showModal('Please login first to submit entries. (Ø§Ù†Ø¯Ø±Ø§Ø¬ Ú©Û’ Ù„ÛŒÛ’ Ù¾ÛÙ„Û’ Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚºÛ”)', 'Login Required');
                return;
            }

            const id = document.getElementById('milk-entry-id').value;
            const date = document.getElementById('milk-entry-date').value;
            let quantity = parseFloat(document.getElementById('milk-entry-quantity').value);
            const isAbsentFlag = milkEntryForm.dataset.isAbsent === 'true'; 

            delete milkEntryForm.dataset.isAbsent; 

            if (isAbsentFlag) {
                quantity = 0.00;
            }

            if (isNaN(quantity) || quantity < 0) {
                showModal('Quantity must be a valid positive number or zero (for absence). (Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø±Ø³Øª Ø¹Ø¯Ø¯ ÛŒØ§ ØµÙØ± ÛÙˆÙ†ÛŒ Ú†Ø§ÛÛŒÛ’)', 'Data Error');
                return;
            }

            showLoading();
            const recordData = {
                id: id, // Will be empty string for new records
                date: date,
                quantity: quantity, 
                isAbsent: isAbsentFlag, 
                timestamp: Date.now(),
            };
            
            const action = id ? 'UPDATE_MILK' : 'ADD_MILK';

            try {
                const result = await callApi(action, recordData, 'POST');
                
                if (result.success) {
                    showModal(`Milk Entry ${id ? 'updated' : 'added'} successfully. (Ø§Ù†Ø¯Ø±Ø§Ø¬ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ${id ? 'ØªØ¨Ø¯ÛŒÙ„' : 'Ø´Ø§Ù…Ù„'} Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”)`);
                    resetMilkForm(); 
                    fetchData(); // Refresh data immediately
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Error saving milk record:", error);
                showModal(`Failed to save Milk Record. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
            }
        });

        paymentEntryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || !groupKey) {
                showModal('Please login first to submit entries. (Ø§Ù†Ø¯Ø±Ø§Ø¬ Ú©Û’ Ù„ÛŒÛ’ Ù¾ÛÙ„Û’ Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚºÛ”)', 'Login Required');
                return;
            }

            const id = document.getElementById('payment-entry-id').value;
            const date = document.getElementById('payment-entry-date').value;
            const amount = parseFloat(document.getElementById('payment-entry-amount').value);

            if (isNaN(amount) || amount <= 0) {
                showModal('Amount must be a valid positive number. (Ø±Ù‚Ù… Ø¯Ø±Ø³Øª Ø¹Ø¯Ø¯ ÛÙˆÙ†ÛŒ Ú†Ø§ÛÛŒÛ’)', 'Data Error');
                return;
            }

            showLoading();
            const recordData = {
                id: id,
                date: date,
                amount: amount, 
                timestamp: Date.now(),
            };
            
            const action = id ? 'UPDATE_PAYMENT' : 'ADD_PAYMENT';


            try {
                const result = await callApi(action, recordData, 'POST');
                
                if (result.success) {
                    showModal(`Payment ${id ? 'updated' : 'added'} successfully. (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ${id ? 'ØªØ¨Ø¯ÛŒÙ„' : 'Ø´Ø§Ù…Ù„'} Ú©Ø± Ø¯ÛŒ Ú¯Ø¦ÛŒ ÛÛ’Û”)`);
                    resetPaymentForm();
                    fetchData(); // Refresh data immediately
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Error saving payment record:", error);
                showModal(`Failed to save Payment Record. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
            }
        });


        // --- Initial Load ---
        window.onload = () => {
            initializeApp();
            
            profileIconBtn.addEventListener('click', showProfileModal);
            profileCloseBtn.addEventListener('click', closeProfileModal);
            logoutBtn.addEventListener('click', handleLogout);
            modalCloseBtn.addEventListener('click', () => { customModal.classList.add('hidden'); });
            
            // Confirmation Modal Listeners
            confirmCancelBtn.addEventListener('click', () => { confirmationModal.classList.add('hidden'); });
            confirmYesBtn.addEventListener('click', async () => {
                if (recordToDeleteId && recordToDeleteType) {
                    confirmationModal.classList.add('hidden');
                    await deleteRecordApi(recordToDeleteId, recordToDeleteType);
                    recordToDeleteId = null;
                    recordToDeleteType = null;
                }
            });

            lucide.createIcons(); 
        };
    </script>

</body>
</html>
