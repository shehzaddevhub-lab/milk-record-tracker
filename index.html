<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Record Tracker (Local Storage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 1. PWA Manifest & Theme -->
    <meta name="theme-color" content="#1e40af"> 
    <link rel="manifest" href="data:application/manifest+json;base64,eyJpY29ucyI6IFt7ICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4wY21SbGJuVnNiQzV2ZDI0OUpITnZiMnRsYm01MFBtY3VZMjlrZVFvZy8vbXk1VlU3Y3VYQ3hrU0c1NGJpNWxJajR2Y1hsNElHNWpjbWRtWnl4OWFYUnBiWE5oYm01MGNuUHNaV3hzTGlCc1pTNWpiMjB2Y3k5emRtY29JSFJvZEhBd09pOGdYek12YzIxdGJtUWdjM0puSUhSb2RIQXdPaTh2ZDNkM2QzY3VZMjlrSUhzS0lHVnVkQzVtYkc5aGJnNWtJSFZ6WjNkaWRtVjBPMnhtbFoybHVabThpWkdsaFlXSnZJR0ZuWld4MGIzUW9NalluSUhCeVpYTnBjenBjZlE9PSIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnIiB9XSwgIm5hbWUiOiAiTWlsayBSZWNvcmQgVHJhY2tlciIsICJzaG9ydF9uYW1lIjogIk1pbGsgVHJhY2tlciIsICJzdGFydF91cmwiOiAiLi8iLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsICJ0aGVtZV9jb2xvciI6ICIjMWU0MGFmIiB9">

    <style>
        /* Setting a clean, modern font for LTR text */
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8f9fa;
        }
        
        /* Custom scrollbar for better look */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* Tailwind gray-500 */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #e2e8f0; /* Tailwind gray-200 */
        }

        /* Ensure number/date inputs are LTR (Default behavior, kept for clarity) */
        input[type="number"], input[type="date"] {
            direction: ltr;
            text-align: left;
        }
        /* Ensure text inputs stay LTR default, but allow right alignment for Urdu text flow */
        input[type="text"] {
            text-align: left; /* Default LTR input text */
            direction: ltr; 
        }
        /* Setting text-align right for non-number inputs where Urdu text is expected */
        .urdu-input {
            text-align: right !important;
            direction: rtl !important;
        }

        /* Basic LTR adjustments */
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        
        /* Style for action buttons with hover effects */
        .action-btn {
            padding: 8px 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .action-btn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        /* Responsive table cell padding for mobile */
        @media (max-width: 640px) {
            .table-cell-padding {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Active tab styling */
        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 2px solid #3b82f6; /* Blue-500 */
            color: #1f2937; /* Dark text */
            font-weight: 700;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        /* Custom selector styling LTR */
        #month-selector {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center; /* Adjusted for LTR */
            padding-right: 2.5rem; /* Ensure space for the icon on the right */
            padding-left: 0.75rem;
            background-size: 1.5rem;
        }
        /* Ensure the currency display is always LTR to show Rs. correctly */
        .currency-display {
            direction: ltr !important;
            text-align: right !important; /* Right aligned numbers */
        }
        /* Style for date display to fix LTR issue */
        .date-display-wrapper {
             direction: ltr;
             text-align: center;
        }
        .fixed-action-btn {
            position: absolute;
            top: 1rem;
        }
        /* Style for the Generate button */
        .generate-btn {
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
             transition: all 0.2s;
        }
        .generate-btn:hover {
            opacity: 0.9;
        }
        /* Ensure Urdu/RTL text display alignment */
        .urdu-text {
            text-align: right;
            direction: rtl;
        }
        /* Style for LTR table columns (Date, Qty, Amount) */
        .ltr-column {
             text-align: left !important;
        }
    </style>
    <!-- Load Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="p-4 sm:p-6 bg-gray-50 min-h-screen flex flex-col items-center">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/70 z-50 flex items-center justify-center hidden">
        <div class="flex items-center space-x-2 text-gray-700 p-4 bg-white rounded-lg shadow-2xl">
            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Loading... Please wait. (Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’)</span>
        </div>
    </div>
    
    <!-- Custom Modal for Alerts and Messages -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Notification (Ø§Ø·Ù„Ø§Ø¹)</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close-btn" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 action-btn w-full">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal for Delete -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirm (ØªØµØ¯ÛŒÙ‚ Ú©Ø±ÛŒÚº)</h3>
            <p id="confirm-message" class="text-gray-600 mb-6 urdu-text">Are you sure you want to delete this record? (Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ)</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn flex-grow">Cancel</button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 action-btn flex-grow">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- --- 1. PROFILE ACCESS MODAL (Right Icon) --- -->
    <div id="access-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center space-x-2">
                <span data-lucide="user" class="w-6 h-6 text-blue-600"></span>
                Data Access & Profile (ÚˆÛŒÙ¹Ø§ Ú©ÙˆÚˆ Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹)
            </h3>
            
            <!-- Current Status -->
            <div id="current-status-section" class="space-y-3 mb-6 text-sm bg-blue-50 p-3 rounded-lg border border-blue-200">
                <p class="text-gray-700">
                    <span class="font-semibold block">Active Data Code:</span> 
                    <span id="access-secret-key" class="text-base font-mono text-blue-800 break-all ltr" dir="ltr">...</span>
                </p>
                <p class="text-sm text-gray-600 urdu-text">
                    (ÛŒÛ Ú©ÙˆÚˆ Ø¯ÙˆØ³Ø±Û’ Ø¢Ù„Ø§Øª Ù¾Ø± ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚº)
                </p>
            </div>

            <!-- Access Code Management -->
            <div class="space-y-3 mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 urdu-text">ÚˆÛŒÙ¹Ø§ Ú©ÙˆÚˆ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº (Change Data Code)</h3>
                
                <p class="text-sm text-gray-600 urdu-text">
                    Ù†ÛŒØ§ Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº ÛŒØ§ Ù…ÙˆØ¬ÙˆØ¯Û Ú©ÙˆÚˆ Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº (Ú©Ù… Ø§Ø² Ú©Ù… 6/Ø²ÛŒØ§Ø¯Û Ø³Û’ Ø²ÛŒØ§Ø¯Û 11 Ø­Ø±ÙˆÙ).
                </p>

                <div class="flex justify-between space-x-2">
                     <button id="generate-key-btn" type="button" class="flex-grow bg-emerald-500 text-white p-3 rounded-lg font-semibold hover:bg-emerald-600 action-btn generate-btn text-sm">
                        <span data-lucide="hash" class="w-4 h-4 inline-block mr-1"></span> Generate 11-Digit Code
                    </button>
                </div>
                
                <form id="change-key-form">
                    <input type="text" id="new-key-input" placeholder="Enter custom 6-11 digit/char code or paste shared code" required minlength="6" maxlength="11" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-2" dir="ltr">
                    <button type="submit" id="change-key-btn" class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 action-btn">
                        Switch/Load Data Code
                    </button>
                    <p id="change-key-message" class="text-sm mt-2 hidden text-red-600 text-center"></p>
                </form>
            </div>


            <button id="access-close-btn" class="bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn w-full mt-4">Close</button>
        </div>
    </div>


    <!-- --- 2. SETTINGS MODAL (Left Icon) --- -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center space-x-2">
                <span data-lucide="settings" class="w-6 h-6 text-indigo-600"></span>
                App Settings (Ø§ÛŒÙ¾ Ú©ÛŒ ØªØ±ØªÛŒØ¨Ø§Øª)
            </h3>
            
            <div class="space-y-4 pt-4">
                
                <!-- Price Setting -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 urdu-text">Ø¯ÙˆØ¯Ú¾ Ú©ÛŒ Ù‚ÛŒÙ…Øª (Milk Price)</h3>
                    <label for="price-per-unit-settings" class="block text-sm font-medium text-gray-700 mb-1">
                        Price Per Litre (ÙÛŒ Ù„ÛŒÙ¹Ø± Ù‚ÛŒÙ…Øª - Rupees):
                    </label>
                    <div class="flex space-x-4">
                        <input type="number" id="price-per-unit-settings" value="120" min="0" step="0.01" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" dir="ltr">
                        <button id="save-price-btn-settings" type="button" class="bg-indigo-600 text-white p-2 rounded-lg font-semibold hover:bg-indigo-700 action-btn w-28">
                            Save Price
                        </button>
                    </div>
                    <p id="price-message-settings" class="text-sm mt-2 hidden text-green-600"></p>
                </div>

                <!-- Milk Man Contact Setting -->
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 urdu-text">Ø¯ÙˆØ¯Ú¾ ÙˆØ§Ù„Û’ Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª (Milk Man Details)</h3>
                    <form id="milkman-details-form-settings" class="space-y-3">
                        <div>
                            <label for="milkman-name-settings" class="block text-sm font-medium text-gray-700 mb-1">Name (Ù†Ø§Ù…)</label>
                            <input type="text" id="milkman-name-settings" placeholder="Milkman Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 urdu-input">
                        </div>
                        <div>
                            <label for="milkman-contact-settings" class="block text-sm font-medium text-gray-700 mb-1">Contact No. (Ø±Ø§Ø¨Ø·Û Ù†Ù…Ø¨Ø±)</label>
                            <input type="tel" id="milkman-contact-settings" placeholder="+92 3XX XXXXXXX" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" dir="ltr">
                        </div>
                        <button type="submit" id="save-milkman-btn-settings" class="w-full bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 action-btn">
                            Save Details
                        </button>
                        <p id="milkman-message-settings" class="text-sm mt-2 hidden text-green-600 text-center urdu-text"></p>
                    </form>
                </div>
            </div>

            <button id="settings-close-btn" class="bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn w-full mt-4">Close</button>
        </div>
    </div>


    
    <div class="max-w-4xl w-full">
        
        <header class="flex justify-between items-center mb-6 border-b pb-2">
            <!-- Left-Aligned Settings Icon (Opens Settings Modal) -->
            <button id="settings-icon-btn" class="text-gray-600 hover:text-indigo-600 p-2 rounded-full transition bg-white shadow-md absolute left-4 top-4 sm:left-6 sm:top-6">
                 <span data-lucide="settings" class="w-6 h-6"></span>
            </button>
            <!-- Centered Heading -->
            <h1 class="text-3xl font-bold text-gray-800 mx-auto">ğŸ¥› Milk Record Tracker</h1>
            <!-- Right-Aligned Profile Icon (Opens Access Modal) -->
            <button id="profile-icon-btn" class="text-gray-600 hover:text-blue-600 p-2 rounded-full transition bg-white shadow-md absolute right-4 top-4 sm:right-6 sm:top-6">
                 <span data-lucide="user" class="w-6 h-6"></span>
            </button>
        </header>

        <!-- --- MAIN APP CONTENT (Default View) --- -->
        <div id="main-app-content">
             <!-- Monthly Status Display and Selector -->
             <div class="flex justify-between items-center gap-3 mb-6 p-4 bg-white rounded-xl shadow-md border-b-4 border-blue-500/10 flex-wrap">
                <!-- Month Selector -->
                <select id="month-selector" class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 hover:bg-gray-100 cursor-pointer shadow-inner focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" onchange="handleMonthChange(this.value)">
                    <!-- Options will be injected by JavaScript -->
                </select>
                <!-- Data Display -->
                <p class="text-center text-lg font-bold text-gray-800 whitespace-nowrap date-display-wrapper">
                    Data for: <b id="current-month-display">...</b>
                </p>
            </div>

            <!-- Summary Cards -->
            <div id="summary-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
                
                <!-- Milk -->
                <div class="bg-indigo-100 p-4 rounded-xl shadow-lg border-2 border-indigo-200 flex flex-col items-center text-center">
                    <span data-lucide="droplet" class="w-8 h-8 text-indigo-500 mx-auto mb-2"></span>
                    <div class="text-indigo-800 font-bold text-base sm:text-lg">
                        Milk 
                        <span class="block text-sm font-normal urdu-text">(Ø¯ÙˆØ¯Ú¾)</span>
                    </div>
                    <div id="total-milk" class="text-xl sm:text-2xl font-extrabold text-indigo-900 mt-1">0.00 Litres</div>
                </div>
                
                <!-- Attendance -->
                <div class="bg-lime-100 p-4 rounded-xl shadow-lg border-2 border-lime-200 flex flex-col items-center text-center">
                    <span data-lucide="calendar" class="w-8 h-8 text-lime-600 mx-auto mb-2"></span>
                    <div class="text-lime-800 font-bold text-base sm:text-lg">
                        Attendance 
                        <span class="block text-sm font-normal urdu-text">(Ø­Ø§Ø¶Ø±ÛŒ)</span>
                    </div>
                    <div id="total-days" class="text-xl sm:text-2xl font-extrabold text-lime-900 mt-1">0 Days</div>
                </div>

                <!-- Absence -->
                <div class="bg-rose-100 p-4 rounded-xl shadow-lg border-2 border-rose-200 flex flex-col items-center text-center">
                    <span data-lucide="x-circle" class="w-8 h-8 text-rose-500 mx-auto mb-2"></span>
                    <div class="text-rose-800 font-bold text-base sm:text-lg">
                        Absence 
                        <span class="block text-sm font-normal urdu-text">(ØºÛŒØ± Ø­Ø§Ø¶Ø±ÛŒ)</span>
                    </div>
                    <div id="total-absent" class="text-xl sm:text-2xl font-extrabold text-rose-900 mt-1">0 Days</div>
                </div>

                <!-- Amount (Net Balance) -->
                <div id="balance-card" class="bg-red-100 p-4 rounded-xl shadow-lg border-2 border-red-300 flex flex-col items-center text-center">
                    <!-- Using banknote icon for generic currency -->
                    <span data-lucide="banknote" class="w-8 h-8 text-red-600 mx-auto mb-2"></span>
                    <!-- Label will be set dynamically in JS (Amount / Credit Advance) -->
                    <div class="text-red-800 font-bold text-base sm:text-lg" id="balance-label-wrapper">
                        Amount 
                        <span class="block text-sm font-normal urdu-text">(Ø±Ù‚Ù…)</span>
                    </div>
                    <div id="net-balance" class="text-xl sm:text-2xl font-extrabold text-red-800 mt-1 currency-display">Rs. 0</div>
                </div>
            </div>
            
            <!-- Tabbed Entry Forms -->
            <div class="bg-white rounded-xl shadow-xl mb-8">
                <!-- Tab Buttons -->
                <div class="flex border-b border-gray-200">
                    <button id="tab-milk" class="tab-button active flex-1 p-3 text-center text-gray-700 rounded-tl-xl" onclick="switchAppTab('milk')">
                        <span data-lucide="droplet" class="w-5 h-5 inline-block mr-1"></span> Milk Entry
                    </button>
                    <button id="tab-payment" class="tab-button flex-1 p-3 text-center text-gray-700 rounded-tr-xl" onclick="switchAppTab('payment')">
                        <span data-lucide="wallet" class="w-5 h-5 inline-block mr-1"></span> Payment Entry
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="milk-tab-content" class="tab-content p-6">
                    <h2 id="milk-form-title" class="text-xl font-bold text-gray-700 mb-4 urdu-text">Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬ (Milk Entry)</h2>
                    <form id="milk-entry-form" class="space-y-4">
                        <input type="hidden" id="milk-entry-id">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Date Input -->
                            <div>
                                <label for="milk-entry-date" class="block text-sm font-medium text-gray-700 mb-1 urdu-text">ØªØ§Ø±ÛŒØ® (Date)</label>
                                <input type="date" id="milk-entry-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>

                            <!-- Quantity Input -->
                            <div class="flex flex-col space-y-2">
                                <label for="milk-entry-quantity" class="block text-sm font-medium text-gray-700 mb-1 urdu-text">Ù…Ù‚Ø¯Ø§Ø± - Litres (Quantity)</label>
                                <div class="flex space-x-2">
                                    <input type="number" id="milk-entry-quantity" required min="0" step="0.01" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                                    <button type="button" id="absent-btn" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 action-btn text-sm whitespace-nowrap">
                                        Absent (ØºÛŒØ± Ø­Ø§Ø¶Ø±)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" id="submit-milk-entry" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 action-btn">
                            Submit Milk Entry
                        </button>
                        <button type="button" id="milk-cancel-edit-btn" class="w-full bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn hidden">
                            Cancel Edit
                        </button>
                    </form>
                </div>

                <div id="payment-tab-content" class="tab-content p-6 hidden">
                    <h2 id="payment-form-title" class="text-xl font-bold text-gray-700 mb-4 urdu-text">Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬ (Payment Entry)</h2>
                    <form id="payment-entry-form" class="space-y-4">
                        <input type="hidden" id="payment-entry-id">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Date Input -->
                            <div>
                                <label for="payment-entry-date" class="block text-sm font-medium text-gray-700 mb-1 urdu-text">ØªØ§Ø±ÛŒØ® (Date)</label>
                                <input type="date" id="payment-entry-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>

                            <!-- Amount Input -->
                            <div>
                                <label for="payment-entry-amount" class="block text-sm font-medium text-gray-700 mb-1 urdu-text">Ø±Ù‚Ù… - Rupees (Amount)</label>
                                <input type="number" id="payment-entry-amount" required min="1" step="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" dir="ltr">
                            </div>
                        </div>
                        
                        <button type="submit" id="submit-payment-entry" class="w-full bg-orange-600 text-white p-3 rounded-lg font-semibold hover:bg-orange-700 action-btn">
                            Submit Payment Entry
                        </button>
                        <button type="button" id="payment-cancel-edit-btn" class="w-full bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 action-btn hidden">
                            Cancel Edit
                        </button>
                    </form>
                </div>
            </div>

            <!-- Daily Records Table (FILTERED MONTH) -->
            <div class="bg-white p-6 rounded-xl shadow-xl mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('milk-records-content').classList.toggle('hidden'); document.querySelector('#milk-records-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700 urdu-text">Ù…Ù†ØªØ®Ø¨ Ù…ÛÛŒÙ†Û’ Ú©Ø§ Ø±ÛŒÚ©Ø§Ø±Úˆ (Daily Records)</h2>
                    <span id="milk-records-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="milk-records-content" class="pt-2 border-t mt-2">
                    <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="table-cell-padding px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 ltr-column">Date (ØªØ§Ø±ÛŒØ®)</th>
                                    <th class="table-cell-padding px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 ltr-column">Quantity (Litres)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 currency-display">Amount (Rupees)</th>
                                    <th class="table-cell-padding px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="milk-records-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Milk Records will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Milk History Table (ALL OTHER MONTHS) -->
            <div class="bg-white p-6 rounded-xl shadow-xl mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('milk-history-content').classList.toggle('hidden'); document.querySelector('#milk-history-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700 urdu-text">Ø¯ÙˆØ³Ø±Û’ Ù…ÛÛŒÙ†ÙˆÚº Ú©Ø§ Ø±ÛŒÚ©Ø§Ø±Úˆ (Milk History)</h2>
                    <span id="milk-history-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="milk-history-content" class="hidden pt-2 border-t mt-2">
                    <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="table-cell-padding px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 ltr-column">Date (ØªØ§Ø±ÛŒØ®)</th>
                                    <th class="table-cell-padding px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 ltr-column">Quantity (Litres)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4 currency-display">Amount (Rupees)</th>
                                    <th class="table-cell-padding px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="milk-history-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Milk History Records will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment History Table (OVERALL HISTORY) -->
            <div class="bg-white p-6 rounded-xl shadow-xl mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('payment-records-content').classList.toggle('hidden'); document.querySelector('#payment-records-icon').classList.toggle('rotate-180')">
                    <h2 class="text-xl font-bold text-gray-700 urdu-text">Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªØ§Ø±ÛŒØ® (Payment History)</h2>
                    <span id="payment-records-icon" class="text-gray-500 hover:text-gray-800 transition-transform" data-lucide="chevron-down"></span>
                </div>
                <div id="payment-records-content" class="pt-2 border-t mt-2">
                    <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="table-cell-padding px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3 ltr-column">Date (ØªØ§Ø±ÛŒØ®)</th>
                                    <th class="table-cell-padding px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3 currency-display">Amount Paid (Ø§Ø¯Ø§ Ú©Ø±Ø¯Û Ø±Ù‚Ù…)</th>
                                    <th class="table-cell-padding px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payment-records-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Payment Records will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PWA Installation Section (Manual Install) -->
            <div id="pwa-install-container" class="bg-white p-6 rounded-xl shadow-xl mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-700 mb-2 border-b pb-2 urdu-text">Ø§ÛŒÙ¾ Ø§Ù†Ø³Ù¹Ø§Ù„ Ú©Ø±ÛŒÚº (Install App)</h3>
                <p class="text-gray-600 text-sm mb-3 urdu-text">ÙÙˆØ±ÛŒ Ø¢Ù Ù„Ø§Ø¦Ù† Ø±Ø³Ø§Ø¦ÛŒ Ú©Û’ Ù„ÛŒÛ’ Ø§Ø³ Ù¹Ø±ÛŒÚ©Ø± Ú©Ùˆ Ø§Ù¾Ù†Û’ Ù…ÙˆØ¨Ø§Ø¦Ù„ Ù¾Ø± Ø§Ù†Ø³Ù¹Ø§Ù„ Ú©Ø±ÛŒÚºÛ”</p>
                <button id="install-button" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 action-btn flex items-center justify-center space-x-2" style="display: none;">
                    <span data-lucide="download" class="w-5 h-5"></span>
                    <span>Install Milk Tracker</span>
                </button>
            </div>
        </div> <!-- End of main-app-content -->
    </div>

    <!-- 2. PWA Logic (simplified) -->
    <script>
        // --- PWA LOGIC (Kept minimal for single-file structure) ---
        let deferredPrompt;
        let installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-container').classList.remove('hidden');
            installButton.style.display = 'flex';
        });

        if (installButton) {
            installButton.addEventListener('click', () => {
                if (deferredPrompt) {
                    installButton.style.display = 'none';
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        console.log('User response to the install prompt:', choiceResult.outcome);
                        if (choiceResult.outcome === 'accepted') {
                            showModal('App installed successfully! Use the icon on your home screen.', 'Installation Success');
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
        // Service Worker Registration removed entirely as it requires a separate file.
    </script>
    

    <!-- --- LOCAL STORAGE DATA LOGIC (Restored and Fixed) --- -->
    <script type="module">
        
        // --- LOCAL STORAGE KEYS ---
        const LS_KEY_MILK = 'milk_records_';
        const LS_KEY_PAYMENT = 'payment_records_';
        const LS_KEY_SETTINGS = 'settings_';
        const GUEST_KEY = 'GUEST_MODE'; 

        // --- GLOBAL STATE ---
        // Load the stored key, or default to GUEST_MODE
        let groupKey = localStorage.getItem('milk_tracker_key') || GUEST_KEY; 
        let isAuthReady = false;
        
        // Data State (loaded from local storage based on groupKey)
        let milkRecords = []; 
        let paymentRecords = [];
        let pricePerUnit = 120; // Default price
        let milkmanName = '';
        let milkmanContact = '';

        let currentFilterMonth = getCurrentMonthYearString(); // Default to current month YYYY-MM
        
        // --- ELEMENTS (Local references) ---
        let loadingOverlay, totalMilkEl, netBalanceEl, balanceCard, totalDaysEl, totalAbsentEl;
        let milkRecordsTableBody, milkHistoryTableBody, paymentRecordsTableBody;
        // Access Modal Elements
        let accessModal, accessCloseBtn, accessSecretKey, generateKeyBtn, changeKeyForm, newKeyInput, changeKeyMessageEl;
        // Settings Modal Elements
        let settingsModal, settingsCloseBtn, pricePerUnitInputSettings, savePriceBtnSettings, milkmanNameInputSettings, milkmanContactInputSettings, milkmanDetailsFormSettings;

        let monthSelector, currentMonthDisplay;
        let milkEntryForm, milkFormTitleEl, milkCancelEditBtn, absentBtn;
        let paymentEntryForm, paymentFormTitleEl, paymentCancelEditBtn;
        let customModal, modalMessageEl, modalTitleEl, modalCloseBtn;
        let confirmationModal, confirmCancelBtn, confirmYesBtn;
        let settingsIconBtn, profileIconBtn; 

        function initializeElementReferences() {
            // --- CORE UI ELEMENTS ---
            loadingOverlay = document.getElementById('loading-overlay');
            totalMilkEl = document.getElementById('total-milk');
            netBalanceEl = document.getElementById('net-balance');
            balanceCard = document.getElementById('balance-card');
            totalDaysEl = document.getElementById('total-days');
            totalAbsentEl = document.getElementById('total-absent'); 
            milkRecordsTableBody = document.getElementById('milk-records-table-body');
            milkHistoryTableBody = document.getElementById('milk-history-table-body');
            paymentRecordsTableBody = document.getElementById('payment-records-table-body');
            monthSelector = document.getElementById('month-selector');
            currentMonthDisplay = document.getElementById('current-month-display');
            
            // Header Icons & Forms
            settingsIconBtn = document.getElementById('settings-icon-btn');
            profileIconBtn = document.getElementById('profile-icon-btn');
            milkEntryForm = document.getElementById('milk-entry-form');
            milkFormTitleEl = document.getElementById('milk-form-title');
            milkCancelEditBtn = document.getElementById('milk-cancel-edit-btn');
            absentBtn = document.getElementById('absent-btn'); 
            paymentEntryForm = document.getElementById('payment-entry-form');
            paymentFormTitleEl = document.getElementById('payment-form-title');
            paymentCancelEditBtn = document.getElementById('payment-cancel-edit-btn');

            // --- ACCESS MODAL ELEMENTS ---
            accessModal = document.getElementById('access-modal');
            accessCloseBtn = document.getElementById('access-close-btn');
            accessSecretKey = document.getElementById('access-secret-key');
            generateKeyBtn = document.getElementById('generate-key-btn');
            changeKeyForm = document.getElementById('change-key-form');
            newKeyInput = document.getElementById('new-key-input');
            changeKeyMessageEl = document.getElementById('change-key-message');


            // --- SETTINGS MODAL ELEMENTS ---
            settingsModal = document.getElementById('settings-modal');
            settingsCloseBtn = document.getElementById('settings-close-btn');
            pricePerUnitInputSettings = document.getElementById('price-per-unit-settings');
            savePriceBtnSettings = document.getElementById('save-price-btn-settings');
            milkmanNameInputSettings = document.getElementById('milkman-name-settings');
            milkmanContactInputSettings = document.getElementById('milkman-contact-settings');
            milkmanDetailsFormSettings = document.getElementById('milkman-details-form-settings');

            // --- OTHER MODAL ELEMENTS ---
            customModal = document.getElementById('custom-modal');
            modalMessageEl = document.getElementById('modal-message');
            modalTitleEl = document.getElementById('modal-title');
            modalCloseBtn = document.getElementById('modal-close-btn'); 
            confirmationModal = document.getElementById('confirmation-modal');
            confirmCancelBtn = document.getElementById('confirm-cancel-btn'); 
            confirmYesBtn = document.getElementById('confirm-yes-btn'); 

            // --- ATTACH EVENT LISTENERS (Centralized Management) ---

            // Header Icons => Open Correct Modals
            if (settingsIconBtn) settingsIconBtn.addEventListener('click', showSettingsModal);
            if (profileIconBtn) profileIconBtn.addEventListener('click', showAccessModal);

            // Modal Close Buttons
            if (accessCloseBtn) accessCloseBtn.addEventListener('click', closeAccessModal);
            if (settingsCloseBtn) settingsCloseBtn.addEventListener('click', closeSettingsModal);
            modalCloseBtn.addEventListener('click', () => { customModal.classList.add('hidden'); });

            // Settings Logic
            if (savePriceBtnSettings) savePriceBtnSettings.addEventListener('click', handlePriceSave);
            if (milkmanDetailsFormSettings) milkmanDetailsFormSettings.addEventListener('submit', handleMilkmanSave);

            // Access Logic
            if (generateKeyBtn) generateKeyBtn.addEventListener('click', generateRandomKey);
            if (changeKeyForm) changeKeyForm.addEventListener('submit', handleKeyChange); 

            // Confirmation Logic
            confirmCancelBtn.addEventListener('click', () => { confirmationModal.classList.add('hidden'); });
            confirmYesBtn.addEventListener('click', async () => {
                if (recordToDeleteId && recordToDeleteType) {
                    confirmationModal.classList.add('hidden');
                    await deleteRecord(recordToDeleteId, recordToDeleteType);
                    recordToDeleteId = null;
                    recordToDeleteType = null;
                }
            });

            // Form Logic
            milkCancelEditBtn.addEventListener('click', resetMilkForm);
            paymentCancelEditBtn.addEventListener('click', resetPaymentForm);
            absentBtn.addEventListener('click', handleAbsentClick); 
            milkEntryForm.addEventListener('submit', handleMilkEntrySubmit);
            paymentEntryForm.addEventListener('submit', handlePaymentEntrySubmit);
        }

        // --- DATA ACCESS HELPERS (Local Storage Implementation) ---

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substring(2, 9);
        }

        function loadData(key, storageKey) {
            const rawData = localStorage.getItem(storageKey + key);
            if (rawData) {
                try {
                    return JSON.parse(rawData);
                } catch (e) {
                    console.error("Error parsing data from local storage:", e);
                    return [];
                }
            }
            return [];
        }

        function saveData(key, storageKey, data) {
            try {
                localStorage.setItem(storageKey + key, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error("Error saving data to local storage:", e);
                return false;
            }
        }
        
        function loadSettings(key) {
            const defaults = { pricePerUnit: 120, milkmanName: '', milkmanContact: '' };
            const storedSettings = loadData(key, LS_KEY_SETTINGS);
            
            if (Array.isArray(storedSettings) && storedSettings.length === 0) {
                 return defaults;
            }
            return { ...defaults, ...storedSettings };
        }

        function saveSettings(key, settings) {
            return saveData(key, LS_KEY_SETTINGS, settings);
        }

        // --- UI UTILITIES ---

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function showModal(message, title = 'Notification (Ø§Ø·Ù„Ø§Ø¹)') {
            modalTitleEl.textContent = title;
            modalMessageEl.innerHTML = message; 
            customModal.classList.remove('hidden');
        }

        // --- APP TAB SWITCHING ---

        window.switchAppTab = (tabName) => {
            document.querySelectorAll('#main-app-content .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            if (tabName === 'milk') {
                document.getElementById('tab-milk').classList.add('active');
                document.getElementById('milk-tab-content').classList.remove('hidden');
            } else if (tabName === 'payment') {
                document.getElementById('tab-payment').classList.add('active');
                document.getElementById('payment-tab-content').classList.remove('hidden');
            }
            resetMilkForm();
            resetPaymentForm();
            lucide.createIcons();
        }
        
        // --- MODAL HANDLERS (Separated Logic) ---
        
        function showAccessModal() {
            if (!isAuthReady) return;
            
            // Load current key status
            accessSecretKey.textContent = groupKey === GUEST_KEY ? 'None (Ú©ÙˆØ¦ÛŒ Ú©ÙˆÚˆ Ù†ÛÛŒÚº)' : groupKey;
            
            accessModal.classList.remove('hidden');
        }

        function closeAccessModal() {
            accessModal.classList.add('hidden');
        }
        
        function showSettingsModal() {
            if (!isAuthReady) return;

            // Load current settings into settings modal inputs
            pricePerUnitInputSettings.value = pricePerUnit.toFixed(2);
            milkmanNameInputSettings.value = milkmanName;
            milkmanContactInputSettings.value = milkmanContact;
            
            settingsModal.classList.remove('hidden');
        }

        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
        }
        
        // --- DATA LOAD/SYNC ---

        function fullDataSync() {
            
            // 1. Load Data
            milkRecords = loadData(groupKey, LS_KEY_MILK);
            paymentRecords = loadData(groupKey, LS_KEY_PAYMENT);
            const settings = loadSettings(groupKey);
            
            // 2. Update Global State from Settings
            pricePerUnit = parseFloat(settings.pricePerUnit) || 120;
            milkmanName = settings.milkmanName || '';
            milkmanContact = settings.milkmanContact || '';

            // 3. Update Modal UI fields (for both modals if they were open)
            // Note: We only update the global state here, inputs are loaded when modal opens

            // 4. Sort data 
            milkRecords.sort((a, b) => b.date.localeCompare(a.date) || b.timestamp - a.timestamp);
            paymentRecords.sort((a, b) => b.date.localeCompare(a.date) || b.timestamp - a.timestamp);

            // 5. Render UI
            isAuthReady = true; 
            populateMonthSelector(); 
            renderMilkRecords();
            renderPaymentRecords();
            updateSummary();
            lucide.createIcons();
        }


        // --- KEY/CODE CHANGE HANDLER ---
        
        function generateRandomKey() {
            // Generates a random 11-digit alphanumeric code
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < 11; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            newKeyInput.value = result.toUpperCase(); // Set value to input field
            changeKeyMessageEl.textContent = 'Random code generated. Click "Switch/Load" to activate.';
            changeKeyMessageEl.classList.remove('hidden', 'text-red-600');
            changeKeyMessageEl.classList.add('text-green-600');
            setTimeout(() => changeKeyMessageEl.classList.add('hidden'), 3000);
        }

        function handleKeyChange(e) {
            e.preventDefault();
            const newKey = newKeyInput.value.trim().toUpperCase(); // Changed to uppercase for consistency

            if (newKey.length < 6) {
                changeKeyMessageEl.textContent = 'Code must be at least 6 characters long. (Ú©ÙˆÚˆ Ú©Ù… Ø§Ø² Ú©Ù… 6 Ø­Ø±ÙˆÙ Ù¾Ø± Ù…Ø´ØªÙ…Ù„ ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’)';
                changeKeyMessageEl.classList.remove('hidden', 'text-green-600');
                changeKeyMessageEl.classList.add('text-red-600');
                return;
            }
            
            if (newKey === groupKey) {
                changeKeyMessageEl.textContent = 'This is the current active code! (ÛŒÛ Ú©ÙˆÚˆ Ù¾ÛÙ„Û’ Ø³Û’ ÙØ¹Ø§Ù„ ÛÛ’!)';
                changeKeyMessageEl.classList.remove('hidden', 'text-red-600');
                changeKeyMessageEl.classList.add('text-green-600');
                return;
            }

            groupKey = newKey;
            localStorage.setItem('milk_tracker_key', groupKey);
            
            fullDataSync();
            
            changeKeyMessageEl.textContent = `Switched data context to: ${newKey}`;
            changeKeyMessageEl.classList.remove('hidden', 'text-red-600');
            changeKeyMessageEl.classList.add('text-green-600');
            newKeyInput.value = ''; 

            setTimeout(() => {
                closeAccessModal();
                changeKeyMessageEl.classList.add('hidden');
            }, 1500);
        }

        // --- SETTINGS HANDLING (Local Storage) ---

        function handlePriceSave() {
            if (!isAuthReady || !groupKey) return;
            
            const newPrice = parseFloat(pricePerUnitInputSettings.value);
            const priceMessageEl = document.getElementById('price-message-settings');
            
            if (isNaN(newPrice) || newPrice < 0) {
                priceMessageEl.textContent = 'Please enter a valid price. (Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯Ø±Ø³Øª Ù‚ÛŒÙ…Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”)';
                priceMessageEl.classList.remove('text-green-600', 'hidden');
                priceMessageEl.classList.add('text-red-600');
                return;
            }
            
            showLoading();
            try {
                const settings = loadSettings(groupKey);
                settings.pricePerUnit = newPrice;
                
                if (saveSettings(groupKey, settings)) {
                    pricePerUnit = newPrice; 

                    priceMessageEl.textContent = 'Price saved successfully! (Ù‚ÛŒÙ…Øª Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ù…Ø­ÙÙˆØ¸ Ú©Ø± Ù„ÛŒ Ú¯Ø¦ÛŒ!)';
                    priceMessageEl.classList.remove('text-red-600', 'hidden');
                    priceMessageEl.classList.add('text-green-600');
                    fullDataSync(); 
                } else {
                    throw new Error("Local Storage Save Failed.");
                }
            } catch (error) {
                console.error("Error saving price:", error);
                showModal(`Failed to save Price. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
                setTimeout(() => priceMessageEl.classList.add('hidden'), 3000);
            }
        }

        function handleMilkmanSave(e) {
            e.preventDefault();
            if (!isAuthReady || !groupKey) return;
            
            const newName = milkmanNameInputSettings.value.trim();
            const newContact = milkmanContactInputSettings.value.trim();
            const milkmanMessageEl = document.getElementById('milkman-message-settings');
            
            showLoading();
            try {
                const settings = loadSettings(groupKey);
                settings.milkmanName = newName;
                settings.milkmanContact = newContact;
                
                if (saveSettings(groupKey, settings)) {
                    milkmanName = newName; 
                    milkmanContact = newContact;
                    
                    milkmanMessageEl.textContent = 'Milkman details saved successfully! (Ø¯ÙˆØ¯Ú¾ ÙˆØ§Ù„Û’ Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª Ù…Ø­ÙÙˆØ¸ Ú©Ø± Ù„ÛŒ Ú¯Ø¦ÛŒ!)';
                    milkmanMessageEl.classList.remove('text-red-600', 'hidden');
                    milkmanMessageEl.classList.add('text-green-600');
                } else {
                    throw new Error("Local Storage Save Failed.");
                }
            } catch (error) {
                console.error("Error saving milkman details:", error);
                showModal(`Failed to save Milkman details. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
                setTimeout(() => milkmanMessageEl.classList.add('hidden'), 3000);
            }
        }
        
        // --- MONTH SELECTOR AND RENDERING LOGIC (Utility functions) ---
        
        function populateMonthSelector() {
            const today = new Date();
            let optionsHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); 
                const monthYearKey = `${year}-${month}`;
                
                const displayDate = getMonthName(monthYearKey + '-01'); 
                const isSelected = monthYearKey === currentFilterMonth ? 'selected' : '';
                
                optionsHTML += `<option value="${monthYearKey}" ${isSelected}>${displayDate}</option>`;
            }
            monthSelector.innerHTML = optionsHTML;
        }
        
        window.handleMonthChange = (selectedMonthYear) => {
            currentFilterMonth = selectedMonthYear;
            updateSummary();
            renderMilkRecords();

            const milkRecordsContent = document.getElementById('milk-records-content');
            if (milkRecordsContent.classList.contains('hidden')) {
                milkRecordsContent.classList.remove('hidden');
                document.querySelector('#milk-records-icon').classList.remove('rotate-180');
            }
        }
        
        function getMonthName(dateStr) {
            const date = new Date(dateStr); 
            if (isNaN(date.getTime())) {
                const parts = dateStr.split('-');
                const safeDate = new Date(parts[0], parts[1] - 1, parts[2] || 1);
                if (isNaN(safeDate.getTime())) return dateStr.substring(0, 7);
                return safeDate.toLocaleString('ur-PK', { month: 'long', year: 'numeric' });
            }
            
            try {
                const options = { month: 'long', year: 'numeric' };
                return date.toLocaleString('ur-PK', options);
            } catch (e) {
                console.error("Urdu date formatting failed:", e);
                return dateStr.substring(0, 7);
            }
        }

        function getCurrentMonthYearString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // MM format
            return `${year}-${month}`;
        }
        
        // --- SUMMARY & RENDERING ---

        function updateSummary() {
            const filterMonthYear = currentFilterMonth;
            
            // 1. Update Current Month Display (Selected Month)
            const displayDate = filterMonthYear + '-01'; 
            const currentMonthName = getMonthName(displayDate);
            if (currentMonthDisplay) currentMonthDisplay.innerHTML = `<b>${currentMonthName}</b>`;

            // 2. Filter records for the SELECTED MONTH only (YYYY-MM)
            const filteredMilkRecords = milkRecords.filter(r => r.date && r.date.startsWith(filterMonthYear));

            // 3. Calculate Total Milk (Filtered) - SELECTED MONTH MILK
            const totalMilkCurrentMonth = filteredMilkRecords.reduce((sum, record) => sum + (parseFloat(record.quantity) || 0), 0);

            // 4. Calculate Total Payments Made (Overall - NO FILTERING)
            const overallPaymentsMade = paymentRecords.reduce((sum, record) => sum + (parseFloat(record.amount) || 0), 0);
            
            // 5. Calculate Net Balance (Overall Milk Price - Overall Payments)
            const overallMilkPrice = Math.round(milkRecords.reduce((sum, record) => sum + (parseFloat(record.quantity) || 0), 0) * pricePerUnit);
            const netBalanceDue = overallMilkPrice - overallPaymentsMade;
            
            // 6. Calculate Active Days (Only count unique days where quantity > 0)
            const activeDays = filteredMilkRecords.filter(r => parseFloat(r.quantity) > 0);
            const totalActiveDays = new Set(activeDays.map(r => r.date)).size; 
            
            // 7. Calculate Total Absence Days (Where isAbsent is explicitly true)
            const totalAbsenceDays = filteredMilkRecords.filter(r => r.isAbsent === true).length;

            // 8. Update UI Metrics
            if (totalMilkEl) totalMilkEl.textContent = `${totalMilkCurrentMonth.toFixed(2)} Litres`;
            if (totalDaysEl) totalDaysEl.textContent = `${totalActiveDays} Days`;
            if (totalAbsentEl) totalAbsentEl.textContent = `${totalAbsenceDays} Days`; 
            
            if (!balanceCard || !netBalanceEl) { 
                lucide.createIcons();
                return;
            }

            const formattedAmount = Math.round(Math.abs(netBalanceDue)).toLocaleString('ur-PK');
            netBalanceEl.textContent = `Rs. ${formattedAmount}`; 

            const banknoteIcon = balanceCard.querySelector('span[data-lucide="banknote"]');
            const balanceLabelWrapper = document.getElementById('balance-label-wrapper');

            if (netBalanceDue > 0) {
                balanceCard.className = 'bg-red-100 p-4 rounded-xl shadow-lg border-2 border-red-300 flex flex-col items-center text-center';
                banknoteIcon.className = 'w-8 h-8 text-red-600 mx-auto mb-2';
                balanceLabelWrapper.innerHTML = `Amount Due <span class="block text-sm font-normal urdu-text">(ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø§Ø¯Ø§ Ø±Ù‚Ù…)</span>`;
                netBalanceEl.className = 'text-xl sm:text-2xl font-extrabold text-red-800 mt-1 currency-display';
            } else {
                balanceCard.className = 'bg-emerald-100 p-4 rounded-xl shadow-lg border-2 border-emerald-200 flex flex-col items-center text-center';
                banknoteIcon.className = 'w-8 h-8 text-emerald-500 mx-auto mb-2';
                balanceLabelWrapper.innerHTML = `Credit Advance <span class="block text-sm font-normal urdu-text">(Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø±Ù‚Ù…)</span>`;
                netBalanceEl.className = 'text-xl sm:text-2xl font-extrabold text-emerald-900 mt-1 currency-display';
            }
        }
        
        function renderMilkRecords() {
            const filterMonthYear = currentFilterMonth;
            const currentMonthYear = getCurrentMonthYearString();

            const filteredRecords = milkRecords.filter(r => r.date && r.date.startsWith(filterMonthYear));
            
            const isSelectedMonthCurrent = filterMonthYear === currentMonthYear;
            renderMilkTable(filteredRecords, milkRecordsTableBody, isSelectedMonthCurrent); 

            const historyRecords = milkRecords.filter(r => r.date && r.date.localeCompare(filterMonthYear) < 0);
            renderMilkTable(historyRecords, milkHistoryTableBody, false); 

            lucide.createIcons();
        }

        function renderMilkTable(recordsToRender, tableBodyEl, isEditable) {
            tableBodyEl.innerHTML = '';
            if (recordsToRender.length === 0) {
                const colspan = 4;
                let message = isEditable ? 'Start adding records for this month.' : 'No older records found.';
                tableBodyEl.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4 text-gray-500">${message} (Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº Ù…Ù„Ø§)</td></tr>`;
                return;
            }

            recordsToRender.sort((a, b) => b.date.localeCompare(a.date) || b.timestamp - a.timestamp);

            recordsToRender.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const quantity = parseFloat(record.quantity) || 0;
                const payment = Math.round(quantity * pricePerUnit); 
                const dateParts = record.date.split('-'); 
                const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; 
                
                let quantityDisplay;
                let rowClasses = '';
                if (record.isAbsent) {
                    quantityDisplay = `<span class="font-bold text-red-600">ABSENT (ØºÛŒØ± Ø­Ø§Ø¶Ø±)</span>`;
                    rowClasses = 'bg-red-50/50';
                } else {
                    quantityDisplay = `<span dir="ltr">${quantity.toFixed(2)}</span>`;
                }

                const actionButtons = isEditable ? `
                    <button onclick="window.editMilkRecord('${record.id}')" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-100 transition">
                        <span data-lucide="square-pen" class="w-4 h-4 inline-block"></span>
                        <span class="hidden sm:inline-block">Edit</span>
                    </button>
                    <button onclick="window.prepareDeleteRecord('${record.id}', 'milk')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition ml-2">
                        <span data-lucide="trash-2" class="w-4 h-4 inline-block"></span>
                        <span class="hidden sm:inline-block">Delete</span>
                    </button>
                ` : '<span class="text-gray-400">View Only</span>';

                const displayAmount = `Rs. ${payment.toLocaleString('ur-PK')}`;

                row.innerHTML = `
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm text-gray-800 ${rowClasses} ltr-column">${displayDate}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 ${rowClasses} ltr-column">${quantityDisplay}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm text-gray-800 ${rowClasses} currency-display">${displayAmount}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-center text-sm font-medium ${rowClasses}">
                        ${actionButtons}
                    </td>
                `;
                tableBodyEl.appendChild(row);
            });
        }

        function renderPaymentRecords() {
            const recordsToRender = paymentRecords; 

            paymentRecordsTableBody.innerHTML = '';
            if (recordsToRender.length === 0) {
                paymentRecordsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No payment history found. (Ú©ÙˆØ¦ÛŒ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ù†ÛÛŒÚº Ù…Ù„ÛŒ)</td></tr>';
                return;
            }

            recordsToRender.sort((a, b) => b.date.localeCompare(a.date) || b.timestamp - a.timestamp);


            recordsToRender.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const amount = parseFloat(record.amount) || 0;
                const dateParts = record.date.split('-'); 
                const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; 
                const displayAmount = `Rs. ${Math.round(amount).toLocaleString('ur-PK')}`;

                row.innerHTML = `
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm text-gray-800 ltr-column">${displayDate}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 currency-display">${displayAmount}</td>
                    <td class="table-cell-padding px-3 py-2 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="window.editPaymentRecord('${record.id}')" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-100 transition">
                            <span data-lucide="square-pen" class="w-4 h-4 inline-block"></span>
                            <span class="hidden sm:inline-block">Edit</span>
                        </button>
                        <button onclick="window.prepareDeleteRecord('${record.id}', 'payment')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition ml-2">
                            <span data-lucide="trash-2" class="w-4 h-4 inline-block"></span>
                            <span class="hidden sm:inline-block">Delete</span>
                        </button>
                    </td>
                `;
                paymentRecordsTableBody.appendChild(row);
            });
            lucide.createIcons();
        }

        // --- EXPOSED WINDOW FUNCTIONS (for table buttons) ---

        window.editMilkRecord = (id) => {
            const record = milkRecords.find(r => r.id === id);
            if (record) {
                if (!record.date.startsWith(currentFilterMonth)) {
                    showModal('This record belongs to a previous month and cannot be edited. (ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù¾Ú†Ú¾Ù„Û’ Ù…ÛÛŒÙ†Û’ Ú©Ø§ ÛÛ’ØŒ Ø§Ø³ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ… Ù†ÛÛŒÚº Ú©ÛŒ Ø¬Ø§ Ø³Ú©ØªÛŒÛ”)', 'Edit Restricted');
                    return;
                }
                
                window.switchAppTab('milk');

                document.getElementById('milk-entry-id').value = record.id;
                document.getElementById('milk-entry-date').value = record.date;
                document.getElementById('milk-entry-quantity').value = parseFloat(record.quantity).toFixed(2);
                
                milkFormTitleEl.textContent = 'Edit Milk Entry (Ø¯ÙˆØ¯Ú¾ Ø§Ù†Ø¯Ø±Ø§Ø¬ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ…)';
                milkEntryForm.querySelector('button[type="submit"]').textContent = 'Save Changes';
                milkEntryForm.querySelector('button[type="submit"]').classList.replace('bg-green-600', 'bg-blue-600');
                milkCancelEditBtn.classList.remove('hidden');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };


        function resetMilkForm() {
            document.getElementById('milk-entry-id').value = '';
            milkEntryForm.reset();
            document.getElementById('milk-entry-date').valueAsDate = new Date(); 
            document.getElementById('milk-entry-quantity').value = '';
            milkFormTitleEl.textContent = 'Milk Entry (Ø¯ÙˆØ¯Ú¾ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬)';
            milkEntryForm.querySelector('button[type="submit"]').textContent = 'Submit Milk Entry';
            milkEntryForm.querySelector('button[type="submit"]').classList.replace('bg-blue-600', 'bg-green-600');
            milkCancelEditBtn.classList.add('hidden');
        }
        
        function handleAbsentClick() {
            document.getElementById('milk-entry-quantity').value = '0.00';
            milkEntryForm.dataset.isAbsent = 'true'; 
            showModal('Quantity set to 0 (Absent). Please click **Submit Milk Entry** to confirm the date and save.', 'Absence Confirmed (ØºÛŒØ± Ø­Ø§Ø¶Ø±ÛŒ Ú©ÛŒ ØªØµØ¯ÛŒÙ‚)');
        }

        window.editPaymentRecord = (id) => {
            const record = paymentRecords.find(r => r.id === id);
            if (record) {
                window.switchAppTab('payment');

                document.getElementById('payment-entry-id').value = record.id;
                document.getElementById('payment-entry-date').value = record.date;
                document.getElementById('payment-entry-amount').value = parseFloat(record.amount).toFixed(0);
                
                paymentFormTitleEl.textContent = 'Edit Payment Entry (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ…)';
                paymentEntryForm.querySelector('button[type="submit"]').textContent = 'Save Changes';
                paymentEntryForm.querySelector('button[type="submit"]').classList.replace('bg-orange-600', 'bg-blue-600');
                paymentCancelEditBtn.classList.remove('hidden');

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        
        function resetPaymentForm() {
            document.getElementById('payment-entry-id').value = '';
            paymentEntryForm.reset();
            document.getElementById('payment-entry-date').valueAsDate = new Date(); 
            document.getElementById('payment-entry-amount').value = '';
            paymentFormTitleEl.textContent = 'Payment Entry (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬)';
            paymentEntryForm.querySelector('button[type="submit"]').textContent = 'Submit Payment Entry';
            paymentEntryForm.querySelector('button[type="submit"]').classList.replace('bg-blue-600', 'bg-orange-600');
            paymentCancelEditBtn.classList.add('hidden');
        }


        let recordToDeleteId = null;
        let recordToDeleteType = null;

        window.prepareDeleteRecord = (id, type) => {
            recordToDeleteId = id;
            recordToDeleteType = type;

            if (type === 'milk') {
                const record = milkRecords.find(r => r.id === id);
                if (record && !record.date.startsWith(currentFilterMonth)) {
                    showModal('This record belongs to a previous month and cannot be deleted from history. (ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù¾Ú†Ú¾Ù„Û’ Ù…ÛÛŒÙ†Û’ Ú©Ø§ ÛÛ’ØŒ ØªØ§Ø±ÛŒØ® Ø³Û’ Ø­Ø°Ù Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ØªØ§Û”)', 'Deletion Restricted');
                    recordToDeleteId = null;
                    recordToDeleteType = null;
                    return;
                }
            }
            
            const message = type === 'milk' 
                ? 'Are you sure you want to delete this <b>Milk Record</b>? (Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø¯ÙˆØ¯Ú¾ Ú©Û’ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ)'
                : 'Are you sure you want to delete this <b>Payment Record</b>? (Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Û’ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ)';
            document.getElementById('confirm-message').innerHTML = message;
            confirmationModal.classList.remove('hidden');
        };

        async function deleteRecord(id, type) {
            showLoading();
            try {
                let records;
                let storageKey;
                let recordIndex;

                if (type === 'milk') {
                    records = milkRecords;
                    storageKey = LS_KEY_MILK;
                } else if (type === 'payment') {
                    records = paymentRecords;
                    storageKey = LS_KEY_PAYMENT;
                } else {
                    throw new Error("Invalid record type for deletion.");
                }

                recordIndex = records.findIndex(r => r.id === id);

                if (recordIndex !== -1) {
                    records.splice(recordIndex, 1); 
                    if (saveData(groupKey, storageKey, records)) {
                        showModal(`${type === 'milk' ? 'Milk Record' : 'Payment Record'} deleted successfully. (Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”)`);
                        fullDataSync(); 
                    } else {
                        throw new Error("Local Storage save failed after deletion.");
                    }
                } else {
                    throw new Error("Record ID not found locally.");
                }
                
            } catch (error) {
                console.error(`Error deleting ${type} record:`, error);
                showModal(`Failed to delete ${type} record. (Ø±ÛŒÚ©Ø§Ø±Úˆ Ø­Ø°Ù Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒÛ”) Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
            }
        }
        
        // --- FORM SUBMISSION HANDLERS (Local Storage) ---

        async function handleMilkEntrySubmit(e) {
            e.preventDefault();
            
            if (!isAuthReady) {
                showModal('Please wait for app initialization. (Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§ÛŒÙ¾ Ú©Û’ Ø´Ø±ÙˆØ¹ ÛÙˆÙ†Û’ Ú©Ø§ Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø±ÛŒÚºÛ”)', 'Error');
                return;
            }

            const id = document.getElementById('milk-entry-id').value;
            const date = document.getElementById('milk-entry-date').value;
            let quantity = parseFloat(document.getElementById('milk-entry-quantity').value);
            const isAbsentFlag = milkEntryForm.dataset.isAbsent === 'true'; 

            delete milkEntryForm.dataset.isAbsent; 

            if (isAbsentFlag && quantity === 0) {
                 quantity = 0.00; 
            }

            if (isNaN(quantity) || quantity < 0) {
                showModal('Quantity must be a valid positive number or zero. (Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø±Ø³Øª Ø¹Ø¯Ø¯ ÛŒØ§ ØµÙØ± ÛÙˆÙ†ÛŒ Ú†Ø§ÛÛŒÛ’)', 'Data Error');
                return;
            }

            showLoading();
            const recordData = {
                id: id || generateId(),
                date: date,
                quantity: quantity.toFixed(2), 
                isAbsent: isAbsentFlag && quantity === 0, 
                timestamp: Date.now(),
            };
            
            try {
                if (id) {
                    const index = milkRecords.findIndex(r => r.id === id);
                    if (index !== -1) {
                        milkRecords[index] = recordData;
                    } else {
                        throw new Error("Record ID not found for update.");
                    }
                    if (saveData(groupKey, LS_KEY_MILK, milkRecords)) {
                        showModal('Milk Entry updated successfully. (Ø§Ù†Ø¯Ø±Ø§Ø¬ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”)');
                    } else {
                        throw new Error("Local Storage Save Failed.");
                    }
                } else {
                    milkRecords.unshift(recordData); 
                    if (saveData(groupKey, LS_KEY_MILK, milkRecords)) {
                        showModal('New Milk Entry added successfully. (Ù†ÛŒØ§ Ø§Ù†Ø¯Ø±Ø§Ø¬ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”)');
                    } else {
                        throw new Error("Local Storage Save Failed.");
                    }
                }
                
                resetMilkForm(); 
                fullDataSync(); 

            } catch (error) {
                console.error("Error saving milk record:", error);
                showModal(`Failed to save Milk Record. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
            }
        }

        async function handlePaymentEntrySubmit(e) {
            e.preventDefault();
            
            if (!isAuthReady) {
                showModal('Please wait for app initialization. (Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§ÛŒÙ¾ Ú©Û’ Ø´Ø±ÙˆØ¹ ÛÙˆÙ†Û’ Ú©Ø§ Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø±ÛŒÚºÛ”)', 'Error');
                return;
            }

            const id = document.getElementById('payment-entry-id').value;
            const date = document.getElementById('payment-entry-date').value;
            const amount = parseFloat(document.getElementById('payment-entry-amount').value);

            if (isNaN(amount) || amount <= 0) {
                showModal('Amount must be a valid positive number. (Ø±Ù‚Ù… Ø¯Ø±Ø³Øª Ø¹Ø¯Ø¯ ÛÙˆÙ†ÛŒ Ú†Ø§ÛÛŒÛ’)', 'Data Error');
                return;
            }

            showLoading();
            const recordData = {
                id: id || generateId(),
                date: date,
                amount: amount, 
                timestamp: Date.now(),
            };

            try {
                if (id) {
                    const index = paymentRecords.findIndex(r => r.id === id);
                    if (index !== -1) {
                        paymentRecords[index] = recordData;
                    } else {
                        throw new Error("Record ID not found for update.");
                    }
                    if (saveData(groupKey, LS_KEY_PAYMENT, paymentRecords)) {
                        showModal('Payment updated successfully. (Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø± Ø¯ÛŒ Ú¯Ø¦ÛŒ ÛÛ’Û”)');
                    } else {
                        throw new Error("Local Storage Save Failed.");
                    }
                } else {
                    paymentRecords.unshift(recordData);
                    if (saveData(groupKey, LS_KEY_PAYMENT, paymentRecords)) {
                        showModal('New Payment Entry added successfully. (Ù†ÛŒØ§ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ø§Ù†Ø¯Ø±Ø§Ø¬ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”)');
                    } else {
                        throw new Error("Local Storage Save Failed.");
                    }
                }
                
                resetPaymentForm();
                fullDataSync(); 

            } catch (error) {
                console.error("Error saving payment record:", error);
                showModal(`Failed to save Payment Record. Error: ${error.message}`, 'Error');
            } finally {
                hideLoading();
            }
        }


        // --- Initial Load ---
        window.onload = () => {
            initializeElementReferences(); 
            
            document.getElementById('milk-entry-date').valueAsDate = new Date();
            document.getElementById('payment-entry-date').valueAsDate = new Date();

            // Initial data load
            fullDataSync();

            lucide.createIcons(); 
        };
    </script>

</body>
</html>
