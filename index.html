<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Milk Tracker</title>
    <meta name="theme-color" content="#1e40af">
    <meta name="google" content="notranslate">
    
    <!-- PWA Links (Icon & Manifest) -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <!-- 1. LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 2. STYLES -->
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8f9fa;
            overscroll-behavior-y: none;
            touch-action: manipulation;
        }
        .font-urdu { font-family: system-ui, -apple-system, sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        /* Input Directions */
        input[type="number"], input[type="date"], input[type="tel"], input[type="month"] { direction: ltr; }
        input[type="text"] { direction: rtl; }
        
        /* Mobile Padding Fix */
        @media (max-width: 640px) { .table-cell-padding { padding: 0.5rem 0.25rem; } }
        
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 3. APPLICATION LOGIC -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Failed', err));
            });
        }

        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(15); };

        const LucideIcon = ({ name, className, onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.className = className;
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' });
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className="inline-flex justify-center items-center"></span>;
        };

        const KEYS = { MILK: 'milk_records_', PAYMENT: 'payment_records_', SETTINGS: 'settings_', GROUP_KEY: 'milk_tracker_key' };
        const DEFAULT_SETTINGS = { pricePerUnit: 120, milkmanName: '', milkmanContact: '' };

        const Storage = {
            getKey: () => localStorage.getItem(KEYS.GROUP_KEY) || 'GUEST_MODE',
            setKey: (k) => localStorage.setItem(KEYS.GROUP_KEY, k),
            getMilk: (k) => { try { return JSON.parse(localStorage.getItem(KEYS.MILK + k) || '[]'); } catch(e){ return []; } },
            saveMilk: (k, d) => localStorage.setItem(KEYS.MILK + k, JSON.stringify(d)),
            getPay: (k) => { try { return JSON.parse(localStorage.getItem(KEYS.PAYMENT + k) || '[]'); } catch(e){ return []; } },
            savePay: (k, d) => localStorage.setItem(KEYS.PAYMENT + k, JSON.stringify(d)),
            getSet: (k) => { try { return {...DEFAULT_SETTINGS, ...JSON.parse(localStorage.getItem(KEYS.SETTINGS + k) || '{}')}; } catch(e){ return DEFAULT_SETTINGS; } },
            saveSet: (k, d) => localStorage.setItem(KEYS.SETTINGS + k, JSON.stringify(d))
        };

        const Toast = ({ msg, show, close }) => {
            useEffect(() => { if(show) setTimeout(close, 2000); }, [show, close]);
            if (!show) return null;
            return (
                <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[100] animate-fade-in w-11/12 max-w-xs">
                    <div className="bg-emerald-600 text-white px-4 py-2.5 rounded-lg shadow-xl flex items-center gap-3 border border-emerald-500">
                        <LucideIcon name="check-circle-2" className="w-5 h-5 text-emerald-100" />
                        <span className="font-bold text-sm">{msg}</span>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ open, close, confirm }) => {
            if (!open) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-xs p-5 text-center">
                        <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <LucideIcon name="alert-triangle" className="w-5 h-5 text-red-600" />
                        </div>
                        <h3 className="text-base font-bold mb-1">Delete Record?</h3>
                        <p className="text-xs text-gray-500 mb-4 font-urdu">Are you sure? (کیا آپ واقعی حذف کرنا چاہتے ہیں؟)</p>
                        <div className="flex gap-2">
                            <button onClick={()=>{vibrate(); close()}} className="flex-1 py-2 bg-gray-100 rounded-lg font-bold text-gray-700 text-sm">Cancel</button>
                            <button onClick={()=>{vibrate(); confirm()}} className="flex-1 py-2 bg-red-600 rounded-lg font-bold text-white text-sm">Delete</button>
                        </div>
                    </div>
                </div>
            );
        };

        const InstallApp = () => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [show, setShow] = useState(false);
            useEffect(() => {
                const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); setShow(true); };
                window.addEventListener('beforeinstallprompt', handler);
                if(window.matchMedia('(display-mode: standalone)').matches) setShow(false);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);
            if (!show) return null;
            const handleInstall = async () => {
                vibrate();
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') setShow(false);
            };
            return (
                <div className="fixed bottom-0 left-0 w-full z-40 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-2 animate-fade-in">
                    <div className="max-w-3xl mx-auto flex items-center justify-between gap-2">
                        <div className="flex-1 text-right">
                            <p className="text-sm font-bold text-gray-800 font-urdu">Install App (ایپ انسٹال کریں)</p>
                            <p className="text-[10px] text-gray-500 font-urdu">آف لائن استعمال کے لیے ڈاؤنلوڈ کریں</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => {vibrate(); setShow(false)}} className="p-1.5 bg-gray-100 rounded-full text-gray-500"><LucideIcon name="x" className="w-4 h-4"/></button>
                            <button onClick={handleInstall} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-md flex items-center gap-1.5 text-xs"><LucideIcon name="download" className="w-3.5 h-3.5"/> Install</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SummaryCards = ({ stats }) => {
            const isPos = stats.net > 0;
            const balLabel = isPos ? 'Amount Due' : 'Credit Advance';
            const balColor = isPos ? 'bg-red-100 border-red-300' : 'bg-emerald-100 border-emerald-200';
            const balTextColor = isPos ? 'text-red-800' : 'text-emerald-900';
            const balIconColor = isPos ? 'text-red-600' : 'text-emerald-600';

            return (
                <div className="grid grid-cols-2 gap-2 mb-3">
                    <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 flex flex-col items-center text-center">
                        <LucideIcon name="droplet" className="w-5 h-5 text-indigo-500 mb-1" />
                        <div className="text-indigo-800 font-bold text-xs">Milk<span className="block text-[10px] font-normal font-urdu">(دودھ)</span></div>
                        <div className="text-lg font-extrabold text-indigo-900 leading-tight">{stats.milk.toFixed(2)} <span className="text-xs">Ltr</span></div>
                    </div>
                    <div className="bg-lime-50 p-3 rounded-xl border border-lime-100 flex flex-col items-center text-center">
                        <LucideIcon name="calendar" className="w-5 h-5 text-lime-600 mb-1" />
                        <div className="text-lime-800 font-bold text-xs">Present<span className="block text-[10px] font-normal font-urdu">(حاضری)</span></div>
                        <div className="text-lg font-extrabold text-lime-900 leading-tight">{stats.days} <span className="text-xs">Days</span></div>
                    </div>
                    <div className="bg-rose-50 p-3 rounded-xl border border-rose-100 flex flex-col items-center text-center">
                        <LucideIcon name="x-circle" className="w-5 h-5 text-rose-500 mb-1" />
                        <div className="text-rose-800 font-bold text-xs">Absent<span className="block text-[10px] font-normal font-urdu">(غیر حاضری)</span></div>
                        <div className="text-lg font-extrabold text-rose-900 leading-tight">{stats.absent} <span className="text-xs">Days</span></div>
                    </div>
                    <div className={`${balColor} p-3 rounded-xl border flex flex-col items-center text-center`}>
                        <LucideIcon name="banknote" className={`w-5 h-5 ${balIconColor} mb-1`} />
                        <div className="text-gray-800 font-bold text-xs">{balLabel}<span className="block text-[10px] font-normal font-urdu">(رقم)</span></div>
                        <div className={`text-lg font-extrabold ${balTextColor} leading-tight`}>Rs. {Math.round(Math.abs(stats.net)).toLocaleString()}</div>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ records, month }) => {
            const [y, m] = month.split('-').map(Number);
            const daysInM = new Date(y, m, 0).getDate();
            const startDay = new Date(y, m - 1, 1).getDay(); // 0=Sun
            const days = Array.from({length: daysInM}, (_, i) => i + 1);
            const pads = Array.from({length: startDay}, (_, i) => i);
            const getR = (d) => records.find(r => r.date === `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-3 mb-4" dir="ltr">
                    <div className="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-bold text-gray-400 uppercase">
                        {['S','M','T','W','T','F','S'].map(d=><div key={d}>{d}</div>)}
                    </div>
                    <div className="grid grid-cols-7 gap-1.5">
                        {pads.map(i=><div key={`p${i}`} />)}
                        {days.map(d => {
                            const r = getR(d);
                            let cls = r ? (r.isAbsent ? 'bg-red-100 text-red-700 font-bold border-red-200' : 'bg-emerald-100 text-emerald-700 font-bold border-emerald-200') : 'bg-gray-50 text-gray-400 border-gray-100';
                            return (
                                <div key={d} className={`aspect-square rounded-lg border ${cls} flex flex-col items-center justify-center text-[10px] relative`}>
                                    <span>{d}</span>
                                    {r && !r.isAbsent && <span className="text-[9px] mt-0.5">{r.quantity}</span>}
                                    {r && r.isAbsent && <div className="w-1.5 h-1.5 bg-red-500 rounded-full mt-0.5"></div>}
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex justify-center gap-3 mt-3 text-[10px] text-gray-500 font-urdu" dir="rtl">
                        <div className="flex items-center gap-1"><div className="w-2.5 h-2.5 bg-emerald-100 border border-emerald-200 rounded"></div><span>Present (حاضر)</span></div>
                        <div className="flex items-center gap-1"><div className="w-2.5 h-2.5 bg-red-100 border border-red-200 rounded"></div><span>Absent (غیر حاضر)</span></div>
                    </div>
                </div>
            );
        };

        const MilkManager = ({ data, add, upd, del, price, month }) => {
            const [dt, setDt] = useState(new Date().toISOString().split('T')[0]);
            const [q, setQ] = useState('');
            const [eid, setEid] = useState(null);
            const [view, setView] = useState('list');
            const listRef = useRef(null);
            
            const cur = useMemo(() => data.filter(r => r.date.startsWith(month)), [data, month]);
            const hist = useMemo(() => data.filter(r => !r.date.startsWith(month)), [data, month]);
            
            const [showHist, setShowHist] = useState(false);

            const sub = (e, abs) => {
                e.preventDefault();
                vibrate();
                const val = parseFloat(q) || 0;
                if (!abs && val <= 0) return;
                const pl = { date: dt, quantity: abs ? 0 : val, isAbsent: abs };
                if(eid) { upd({...data.find(r=>r.id===eid), ...pl}); setEid(null); }
                else add(pl);
                if(!eid) setQ('');
            };

            const renderTable = (list, title, toggle=false, isHidden=false, onToggle=null) => (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-3 font-urdu">
                    <div 
                        className={`p-3 bg-gray-50 border-b flex justify-between items-center ${toggle ? 'cursor-pointer hover:bg-gray-100 transition-colors' : ''}`} 
                        onClick={toggle ? onToggle : undefined}
                    >
                        {toggle && <LucideIcon name={isHidden ? 'chevron-down' : 'chevron-up'} className="w-4 h-4 text-gray-400"/>}
                        <h3 className={`font-bold text-gray-700 text-sm w-full text-right ${toggle ? 'pr-2' : ''}`}>{title}</h3>
                    </div>
                    
                    {!isHidden && (
                        <div className="overflow-x-auto max-h-64 overflow-y-auto" ref={list === cur ? listRef : null}>
                            <table className="w-full text-xs text-gray-600 text-right">
                                <thead className="bg-gray-50 border-b sticky top-0">
                                    <tr>
                                        <th className="px-3 py-2 text-right">Date</th>
                                        <th className="px-3 py-2 text-right">Qty</th>
                                        <th className="px-3 py-2 text-right">Amt</th>
                                        <th className="px-3 py-2 text-center">Act</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {list.length === 0 ? (
                                        <tr><td colSpan={4} className="p-4 text-center text-gray-400 text-[10px] italic">No records</td></tr>
                                    ) : (
                                        list.map(r => (
                                            <tr key={r.id} className={r.isAbsent ? 'bg-red-50' : 'border-b last:border-0'}>
                                                <td className="px-3 py-2" dir="ltr">{r.date.split('-').reverse().join('/')}</td>
                                                <td className="px-3 py-2" dir="ltr">{r.isAbsent ? <span className="text-red-600 font-bold" dir="rtl">ABSENT</span> : r.quantity.toFixed(2)}</td>
                                                <td className="px-3 py-2 font-mono" dir="ltr">{Math.round(r.quantity * (r.pricePerUnit || price)).toLocaleString()}</td>
                                                <td className="px-3 py-2 flex justify-center gap-2">
                                                    <button onClick={() => { vibrate(); setDt(r.date); setQ(r.quantity); setEid(r.id); window.scrollTo(0, 0); }} className="text-blue-600"><LucideIcon name="square-pen" className="w-4 h-4" /></button>
                                                    <button onClick={() => { vibrate(); del(r.id) }} className="text-red-600"><LucideIcon name="trash-2" className="w-4 h-4" /></button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="space-y-3">
                    <div className="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                        <h2 className="text-lg font-bold mb-4 text-center text-gray-800 font-urdu">دودھ کا اندراج (Milk Entry)</h2>
                        <form className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1 text-right">تاریخ (Date)</label>
                                <div className="relative">
                                    <input type="date" value={dt} onChange={e=>setDt(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-lg text-center outline-none focus:ring-2 focus:ring-green-500 text-sm font-bold text-gray-700" dir="ltr" lang="en-GB"/>
                                </div>
                            </div>
                            
                            <div className="flex gap-3 items-end">
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 mb-1 text-right">مقدار - Ltr (Quantity)</label>
                                    <input type="number" step="0.01" value={q} onChange={e=>setQ(e.target.value)} placeholder="0.00" className="w-full p-2.5 border border-gray-300 rounded-lg text-right outline-none focus:ring-2 focus:ring-green-500 text-sm" dir="ltr"/>
                                </div>
                                <div className="w-auto flex items-end">
                                    <button 
                                        type="button" 
                                        onClick={e=>sub(e,true)} 
                                        className="h-[42px] px-4 bg-red-600 text-white rounded-lg text-xs font-bold flex flex-col items-center justify-center border border-red-700 shadow-sm active:scale-95 transition-transform hover:bg-red-700"
                                    >
                                        <span>Absent</span>
                                        <span className="font-urdu text-[9px]">(غیر حاضر)</span>
                                    </button>
                                </div>
                            </div>
                            <div className="pt-1">
                                <button type="button" onClick={e=>sub(e,false)} className={`w-full py-3 rounded-lg font-bold text-white shadow-md active:scale-95 transition-transform text-sm ${eid?'bg-blue-600':'bg-green-600 hover:bg-green-700'}`}>{eid?'Update Entry':'Submit Entry'}</button>
                                {eid && <button type="button" onClick={()=>{vibrate(); setEid(null);setQ('')}} className="w-full mt-2 py-2 text-gray-500 font-bold bg-gray-100 rounded-lg text-xs">Cancel</button>}
                            </div>
                        </form>
                    </div>
                    <div className="flex justify-between items-center px-1">
                        <h3 className="font-bold text-gray-600 text-sm">Records</h3>
                        <div className="flex gap-1 bg-white p-0.5 rounded-lg border shadow-sm">
                            <button onClick={()=>{vibrate(); setView('list')}} className={`p-1.5 rounded-md transition-all ${view==='list'?'bg-blue-50 text-blue-600':'text-gray-400 hover:text-gray-600'}`}><LucideIcon name="list" className="w-4 h-4"/></button>
                            <button onClick={()=>{vibrate(); setView('calendar')}} className={`p-1.5 rounded-md transition-all ${view==='calendar'?'bg-blue-50 text-blue-600':'text-gray-400 hover:text-gray-600'}`}><LucideIcon name="calendar" className="w-4 h-4"/></button>
                        </div>
                    </div>
                    
                    {view==='list' ? renderTable(cur, 'Daily Records (موجودہ ریکارڈ)') : <CalendarView records={cur} month={month} />}
                    
                    {/* PREVIOUS HISTORY (COLLAPSIBLE) */}
                    {hist.length > 0 && renderTable(hist, 'Previous History (پرانا ریکارڈ)', true, !showHist, () => {vibrate(); setShowHist(!showHist)})}
                </div>
            );
        };

        const PaymentManager = ({ data, add, upd, del }) => {
            const [dt, setDt] = useState(new Date().toISOString().split('T')[0]);
            const [a, setA] = useState('');
            const [eid, setEid] = useState(null);
            
            const sub = (e) => {
                e.preventDefault();
                vibrate();
                const val = parseFloat(a) || 0;
                if (val <= 0) return;
                const pl = { date: dt, amount: val };
                if(eid) { upd({...data.find(r=>r.id===eid), ...pl}); setEid(null); } else add(pl);
                if(!eid) setA('');
            };

            return (
                <div className="space-y-4">
                    <div className="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                        <h2 className="text-lg font-bold mb-4 text-center text-gray-800 font-urdu">ادائیگی کا اندراج (Payment Entry)</h2>
                        <form onSubmit={sub} className="space-y-4">
                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-right text-gray-500 mb-1">تاریخ (Date)</label>
                                    <input type="date" value={dt} onChange={e=>setDt(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-lg text-center outline-none focus:ring-2 focus:ring-orange-500 text-sm" dir="ltr" lang="en-GB"/>
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-right text-gray-500 mb-1">رقم (Amount)</label>
                                    <input type="number" value={a} onChange={e=>setA(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-lg text-right outline-none focus:ring-2 focus:ring-orange-500 text-sm" dir="ltr" placeholder="0"/>
                                </div>
                            </div>
                            <div className="pt-1">
                                <button type="submit" className={`w-full py-3 rounded-lg font-bold text-white shadow-md active:scale-95 transition-transform text-sm ${eid?'bg-blue-600':'bg-orange-600 hover:bg-orange-700'}`}>{eid?'Update Entry':'Submit Payment'}</button>
                                {eid && <button type="button" onClick={()=>{vibrate(); setEid(null);setA('')}} className="w-full mt-2 py-2 text-gray-500 font-bold bg-gray-100 rounded-lg text-xs">Cancel</button>}
                            </div>
                        </form>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-2 font-urdu">
                        <div className="p-3 bg-gray-50 border-b"><h3 className="font-bold text-sm text-right">Payment History</h3></div>
                        <div className="overflow-x-auto max-h-56 overflow-y-auto"><table className="w-full text-xs text-gray-600 text-right">
                            <thead className="bg-gray-50 border-b sticky top-0"><tr><th className="px-3 py-2 text-right">Date</th><th className="px-3 py-2 text-right">Paid</th><th className="px-3 py-2 text-center">Act</th></tr></thead>
                            <tbody>{data.length===0 ? <tr><td colSpan={3} className="p-4 text-center text-gray-400 italic">No payments</td></tr> : data.map(r=>(
                                <tr key={r.id}>
                                    <td className="px-3 py-2" dir="ltr">{r.date.split('-').reverse().join('/')}</td>
                                    <td className="px-3 py-2 font-bold text-emerald-700" dir="ltr">{r.amount.toLocaleString()}</td>
                                    <td className="px-3 py-2 flex justify-center gap-2">
                                        <button type="button" onClick={()=>{vibrate(); setDt(r.date);setA(r.amount);setEid(r.id);window.scrollTo(0,0)}} className="text-blue-600"><LucideIcon name="square-pen" className="w-4 h-4"/></button>
                                        <button type="button" onClick={()=>{vibrate(); del(r.id)}} className="text-red-600"><LucideIcon name="trash-2" className="w-4 h-4"/></button>
                                    </td>
                                </tr>
                            ))}</tbody>
                        </table></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [key, setKey] = useState(Storage.getKey());
            const [milk, setMilk] = useState([]);
            const [pay, setPay] = useState([]);
            const [set, setSet] = useState(DEFAULT_SETTINGS);
            const [tab, setTab] = useState('milk');
            const [menuOpen, setMenuOpen] = useState(false);
            const [toast, setToast] = useState({m:'', s:false});
            const [del, setDel] = useState(null);
            const [mon, setMon] = useState(new Date().toISOString().substring(0,7));
            const [modal, setModal] = useState({set:false, acc:false});
            const [batchMon, setBatchMon] = useState('');
            const [showAdv, setShowAdv] = useState(false);

            useEffect(() => {
                setMilk(Storage.getMilk(key));
                setPay(Storage.getPay(key));
                setSet(Storage.getSet(key));
                setBatchMon(mon);
            }, [key]);

            useEffect(() => Storage.saveMilk(key, milk), [milk]);
            useEffect(() => Storage.savePay(key, pay), [pay]);
            useEffect(() => Storage.saveSet(key, set), [set]);
            useEffect(() => Storage.setKey(key), [key]);

            const notify = (m) => { vibrate(); setToast({m, s:true}); };
            const stats = useMemo(() => {
                const curMonthRecords = milk.filter(r => r.date.startsWith(mon));
                const tM = curMonthRecords.reduce((a, r) => a + r.quantity, 0);
                const presentDays = new Set(curMonthRecords.filter(r => !r.isAbsent).map(r => r.date)).size;
                const absentDays = curMonthRecords.filter(r => r.isAbsent).length;
                const totalCostAllTime = milk.reduce((a, r) => a + (r.quantity * (r.pricePerUnit || set.pricePerUnit)), 0);
                const totalPaidAllTime = pay.reduce((a, r) => a + r.amount, 0);
                return { milk: tM, days: presentDays, absent: absentDays, net: totalCostAllTime - totalPaidAllTime };
            }, [milk, pay, set.pricePerUnit, mon]);

            const months = useMemo(() => Array.from({length:12}, (_,i)=>{
                const d = new Date(); d.setMonth(d.getMonth()-i);
                return {v: d.toISOString().substring(0,7), l: d.toLocaleString('default',{month:'long',year:'numeric'})};
            }), []);

            const batchUpdate = (m, p) => {
                vibrate();
                if(!confirm(`Update price for all records in ${m}?`)) return;
                setMilk(prev => prev.map(r => r.date.startsWith(m) ? {...r, pricePerUnit: p} : r));
                notify('Batch Updated');
            };

            const genKey = (setter) => {
                vibrate();
                const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let r = ''; for(let i=0;i<8;i++) r += c.charAt(Math.floor(Math.random()*c.length));
                setter(r);
            };

            const backupData = () => {
                vibrate();
                const data = {
                    milk: Storage.getMilk(key),
                    payment: Storage.getPay(key),
                    settings: Storage.getSet(key),
                    date: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `milk_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                notify("Backup Downloaded");
            };

            const restoreData = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.milk && data.payment) {
                            if(confirm("Are you sure? This will replace your current data.\n(کیا آپ واقعی پرانا ڈیٹا ختم کر کے یہ فائل بحال کرنا چاہتے ہیں؟)")) {
                                vibrate();
                                setMilk(data.milk);
                                setPay(data.payment);
                                if(data.settings) setSet(data.settings);
                                notify("Data Restored!");
                                setModal({...modal, set:false});
                            }
                        } else {
                            alert("Invalid Backup File");
                        }
                    } catch(err) {
                        alert("Error reading file");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex justify-center pb-16">
                    <div className="w-full max-w-md p-3">
                        <Toast msg={toast.m} show={toast.s} close={()=>setToast({...toast,s:false})}/>
                        <ConfirmModal open={del} close={()=>setDel(null)} confirm={()=>{
                            if(del.t==='m') setMilk(p=>p.filter(r=>r.id!==del.id));
                            else setPay(p=>p.filter(r=>r.id!==del.id));
                            setDel(null); notify('Deleted');
                        }}/>
                        
                        {/* TOGGLE ARROW HEADER */}
                        <div className="flex justify-center py-2">
                            <button 
                                onClick={() => {vibrate(); setMenuOpen(!menuOpen)}} 
                                className="text-gray-400 hover:text-gray-600 transition-colors p-1 outline-none"
                            >
                                <LucideIcon name={menuOpen ? "chevron-up" : "chevron-down"} className="w-6 h-6" />
                            </button>
                        </div>

                        {/* COLLAPSIBLE MENU */}
                        {menuOpen && (
                            <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-4 flex justify-between items-center animate-fade-in mx-1">
                                {/* Profile (Right in RTL) */}
                                <button onClick={()=>{vibrate(); setModal({...modal,acc:true})}} className="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-800 min-w-[60px]">
                                    <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center border border-gray-100">
                                        <LucideIcon name="user-circle" className="w-6 h-6 text-gray-500"/>
                                    </div>
                                    <span className="text-[10px] font-medium text-gray-500">Profile</span>
                                </button>

                                {/* Month Selector (Center) */}
                                <div className="flex flex-col items-center flex-1 px-2">
                                    <div className="relative w-full max-w-[140px]">
                                        <select value={mon} onChange={e=>{vibrate(); setMon(e.target.value)}} className="w-full appearance-none bg-white border border-gray-200 rounded-lg py-1.5 px-2 text-sm font-bold text-gray-700 shadow-sm outline-none focus:border-blue-400 dir-ltr text-center">
                                            {months.map(o=><option key={o.v} value={o.v}>{o.l}</option>)}
                                        </select>
                                        <div className="absolute inset-y-0 left-2 flex items-center pointer-events-none">
                                            <LucideIcon name="chevron-down" className="w-3 h-3 text-gray-400"/>
                                        </div>
                                    </div>
                                    <span className="text-[9px] text-gray-400 mt-1">Select Month</span>
                                </div>

                                {/* Settings (Left in RTL) */}
                                <button onClick={()=>{vibrate(); setModal({...modal,set:true})}} className="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-800 min-w-[60px]">
                                    <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center border border-gray-100">
                                        <LucideIcon name="settings" className="w-6 h-6 text-gray-500"/>
                                    </div>
                                    <span className="text-[10px] font-medium text-gray-500">Settings</span>
                                </button>
                            </div>
                        )}

                        <SummaryCards stats={stats} />
                        
                        {/* COMPACT TABS */}
                        <div className="bg-gray-200 p-1 rounded-lg flex gap-1 mb-4 mt-2">
                            <button onClick={()=>{vibrate(); setTab('milk')}} className={`flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-1.5 transition-all ${tab==='milk'?'bg-white text-blue-600 shadow-sm':'text-gray-500'}`}>
                                <span>Milk Entry</span> <LucideIcon name="droplet" className="w-3.5 h-3.5"/>
                            </button>
                            <button onClick={()=>{vibrate(); setTab('payment')}} className={`flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-1.5 transition-all ${tab==='payment'?'bg-white text-orange-600 shadow-sm':'text-gray-500'}`}>
                                <span>Payments</span> <LucideIcon name="wallet" className="w-3.5 h-3.5"/>
                            </button>
                        </div>

                        {tab==='milk' ? <MilkManager data={milk} price={set.pricePerUnit} month={mon} 
                            add={r=>{setMilk(p=>[{...r,pricePerUnit:set.pricePerUnit,id:Date.now().toString()},...p].sort((a,b)=>b.date.localeCompare(a.date)));notify('Added')}}
                            upd={u=>{setMilk(p=>p.map(r=>r.id===u.id?u:r).sort((a,b)=>b.date.localeCompare(a.date)));notify('Updated')}}
                            del={id=>setDel({id,t:'m'})}
                        /> : <PaymentManager data={pay} 
                            add={r=>{setPay(p=>[{...r,id:Date.now().toString()},...p].sort((a,b)=>b.date.localeCompare(a.date)));notify('Paid')}}
                            upd={u=>{setPay(p=>p.map(r=>r.id===u.id?u:r).sort((a,b)=>b.date.localeCompare(a.date)));notify('Updated')}}
                            del={id=>setDel({id,t:'p'})}
                        />}

                        <InstallApp />

                        <div className="mt-6 text-center text-[10px] text-gray-400 font-urdu pb-2">Safe & Local Data • {set.milkmanName && `Milkman: ${set.milkmanName}`}</div>

                        {/* Settings Modal */}
                        {modal.set && <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-xl w-full max-w-md overflow-hidden shadow-2xl">
                                <div className="p-4 border-b flex justify-between items-center">
                                    <h2 className="font-bold text-xl text-gray-800">Settings (سیٹنگز)</h2>
                                    <button onClick={()=>{vibrate(); setModal({...modal,set:false})}} className="p-1 hover:bg-gray-100 rounded-full">
                                        <LucideIcon name="x" className="w-5 h-5 text-gray-500"/>
                                    </button>
                                </div>
                                <div className="p-6 overflow-y-auto max-h-[85vh]">
                                    <div className="mb-6">
                                        <label className="block text-sm font-bold text-gray-700 mb-2 text-right">Default Price Per Liter (فی لیٹر قیمت)</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-semibold text-lg">Rs.</span>
                                            <input type="number" min="0" step="0.01" value={set.pricePerUnit} onChange={e=>setSet({...set,pricePerUnit:parseFloat(e.target.value)})} className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-left text-lg text-gray-800"/>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-2 text-right leading-relaxed font-urdu">نئی قیمت صرف نئے اندراجات پر لاگو ہوگی۔ پرانے ریکارڈ تبدیل نہیں ہوں گے۔</p>
                                    </div>
                                    <div>
                                        <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 text-center">MILKMAN DETAILS</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-1 text-right">Name (نام)</label>
                                                <input type="text" value={set.milkmanName} onChange={e=>setSet({...set,milkmanName:e.target.value})} placeholder="Milkman Name" className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-right"/>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-1 text-right">Contact (رابطہ نمبر)</label>
                                                <input type="tel" value={set.milkmanContact} onChange={e=>setSet({...set,milkmanContact:e.target.value})} placeholder="03XX XXXXXXX" className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-left" dir="ltr"/>
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={()=>{vibrate(); setModal({...modal,set:false}); notify('Settings Saved')}} className="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 mt-8">
                                        <LucideIcon name="save" className="w-5 h-5"/> Save Settings
                                    </button>
                                    <div className="mt-4">
                                        <button onClick={()=>{vibrate(); setShowAdv(!showAdv)}} className="text-indigo-600 text-sm font-medium mb-3 hover:underline w-full text-right block">{showAdv ? "Hide Options" : "Show Advanced Options"}</button>
                                        {showAdv && (
                                            <div className="space-y-4 animate-fade-in">
                                                <div className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                                    <h3 className="font-bold text-orange-900 text-sm mb-2 text-right flex items-center justify-end gap-2">بیچ پرائس اپ ڈیٹ (Batch Price Update) <LucideIcon name="alert-triangle" className="w-4 h-4 text-orange-600"/></h3>
                                                    <p className="text-orange-800 text-xs text-right mb-3 font-urdu leading-relaxed">منتخب مہینے کے تمام <span className="underline font-bold">پرانے ریکارڈز</span> پر یہ قیمت (Rs. {set.pricePerUnit}) لاگو کریں۔</p>
                                                    <div className="flex gap-2 items-center">
                                                        <button onClick={()=>batchUpdate(batchMon, set.pricePerUnit)} className="bg-orange-300 text-orange-900 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-orange-400 transition-colors whitespace-nowrap">Apply</button>
                                                        <input type="month" value={batchMon} onChange={e=>setBatchMon(e.target.value)} className="flex-1 p-2 border border-orange-200 rounded text-sm bg-white outline-none focus:border-orange-400 text-right"/>
                                                    </div>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                    <h3 className="font-bold text-gray-700 text-sm mb-2 text-right">Data Backup (ڈیٹا بیک اپ)</h3>
                                                    <div className="flex gap-2">
                                                        <button onClick={backupData} className="flex-1 bg-teal-600 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 shadow hover:bg-teal-700"><LucideIcon name="download" className="w-3 h-3"/> Download</button>
                                                        <label className="flex-1 bg-gray-600 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 shadow hover:bg-gray-700 cursor-pointer"><LucideIcon name="upload" className="w-3 h-3"/> Restore<input type="file" accept=".json" className="hidden" onChange={restoreData}/></label>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>}
                        
                        {/* Access Modal */}
                        {modal.acc && <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl">
                                <div className="p-4 border-b flex justify-between items-center">
                                    <h2 className="font-bold text-lg text-gray-800 flex items-center gap-2"><LucideIcon name="key" className="w-5 h-5 text-blue-600"/> Data Access</h2>
                                    <button onClick={()=>{vibrate(); setModal({...modal,acc:false})}} className="p-2 hover:bg-gray-100 rounded-full"><LucideIcon name="x" className="w-5 h-5 text-gray-500"/></button>
                                </div>
                                <div className="p-6 text-center space-y-4">
                                    <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 text-center">
                                        <p className="text-blue-600 font-bold text-xs uppercase tracking-wider mb-2">CURRENT ACTIVE CODE</p>
                                        <h2 className="text-3xl font-bold text-blue-900 font-mono tracking-widest break-all">{key}</h2>
                                        <p className="text-blue-400 text-xs mt-2 font-urdu">(یہ کوڈ اپنے پاس محفوظ رکھیں)</p>
                                    </div>
                                    <div>
                                        <h3 className="text-center text-gray-600 font-semibold mb-4">Switch or Load Profile</h3>
                                        <div className="flex gap-3 mb-4">
                                            <input id="nk" placeholder="ENTER CODE" className="flex-1 border border-gray-300 rounded-lg text-center font-mono uppercase tracking-widest outline-none focus:ring-2 focus:ring-blue-500 text-gray-600 p-3" dir="ltr"/>
                                            <button type="button" onClick={()=>{vibrate(); genKey((v)=>document.getElementById('nk').value=v)}} className="bg-emerald-100 text-emerald-600 p-3 rounded-lg hover:bg-emerald-200 transition-colors"><LucideIcon name="refresh-cw" className="w-6 h-6"/></button>
                                        </div>
                                        <button onClick={()=>{const k=document.getElementById('nk').value.trim().toUpperCase();if(k.length>3){vibrate(); setKey(k);setModal({...modal,acc:false});notify('Loaded')}}} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-lg shadow-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"><LucideIcon name="log-in" className="w-5 h-5"/> Load / Switch Profile</button>
                                    </div>
                                </div>
                            </div>
                        </div>}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
